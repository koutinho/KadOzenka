<div class="form-horizontal col-sm-12" style="padding-top: 2%">
    <div class="form-group">
        <div class="col-sm-2">
            @Html.CustomLabel("Сегмент")
        </div>
        <div class="col-sm-4">
            @(Html.Kendo().DropDownList()
                .Name("SegmentsDownList")
                .DataTextField("Text")
                .DataValueField("Value")
                .BindTo((System.Collections.IEnumerable)ViewBag.Segments))
        </div>
    </div>

    <div class="form-group" style="padding: 2%">
        <div id="historyGrid"></div>
    </div>
</div>


@section styles {
    <link rel="stylesheet" href="~/css/jquery.fancybox.min.css" />
    <style>
        .k-header .k-link {
            text-align: center;
        }

        #Grid {
            text-align: center;
        }
    </style>
}

<script>
    $(document).ready(function () {
        reloadHistory();
        $('[name="SegmentsDownList"]').data('kendoDropDownList').bind('change', reloadHistory);

    });

    function reloadHistory() {
        var marketSegmentCode = $('[name="SegmentsDownList"]').val();

        var historyGridDataSource = new kendo.data.DataSource({
            transport: {
                read: {
                    url: '@Url.Action("GetCorrectionByStageGeneralHistory", "MarketObjects")',
                    contentType: 'application/json; charset=utf-8',
                    data: { marketSegmentCode: marketSegmentCode },
                    dataType: 'json'
                }
            },
            schema: {
                model: {
                    fields: {
                        Date: { editable: false},                        
                        StageCoefficient: { editable: false }
                    }
                }
            },
            pageSize: 10
        });

        var hrefTemplate = '<a target="_blank" href="/MarketObjects/CorrectionByStageDetailedHistory?date=#=Date#&marketSegmentCode=' + marketSegmentCode + '">#=';

        $('#historyGrid').kendoGrid({
            dataSource: historyGridDataSource,
            columns: [
                {
                    field: 'Date',
                    title: 'Месяц',
                    template: "#= kendo.toString(kendo.parseDate(Date, 'yyyy-MM-dd'), 'MMMM yyyy') #"
                }, {
                    field: 'StageCoefficient',
                    title: 'Коэффициент на этажность',
                    template: hrefTemplate + 'StageCoefficient#</a>'
                }
            ],
            scrollable: true,
            pageable: true
        });
    }
</script>