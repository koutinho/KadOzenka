@using Newtonsoft.Json;
@using CIPJS.Models.ReestrPay;

@model ChangeDateDto

<div id="toolbar"></div>
<form method="post" action="ChangeStatus">
    <div class="form-horizontal col-sm-12">
        <div class="form-group"></div>
        <div class="form-group">
            <div class="col-sm-2">
                <label class="control-label">Дата</label>
            </div>
            <div class="col-sm-4">
                @Html.KendoDatePickerFor(x => x.Date, false)
            </div>
        </div>
    </div>
</form>

<script type="text/javascript">
    $(document).ready(function () {
        var model = @Html.Raw(JsonConvert.SerializeObject(Model)),
            datePicker = $('#Date').data('kendoDatePicker');

        $('#toolbar').kendoToolBar({
            items: [
                {
                    type: 'button',
                    text: 'Сохранить',
                    icon: 'check',
                    click: function () {
                        Common.ClearNotification();
                        kendo.ui.progress($('body'), true);

                        var newDate = datePicker.value(),
                            oldDate = kendo.parseDate(model.Date),
                            message = 'Вы подтверждаете изменение даты реестра' +
                                (oldDate != undefined && oldDate != null ? ' c ' + kendo.toString(oldDate, 'dd.MM.yyyy') : '') +
                                (newDate != undefined && newDate != null ? ' на ' + kendo.toString(newDate, 'dd.MM.yyyy') : '') + '?';


                        Common.UI.ShowConfirm({
                            title: 'Подтверждение',
                            content: message,
                            onSuccess: function (e) {
                                $.ajax({
                                    url: '@Url.Action("ChangeDate", "ReestrPay")',
                                    type: 'POST',
                                    data: { PayId: model.PayId, Date: kendo.toString(newDate, 'dd.MM.yyyy HH:mm:ss') },
                                    success: function(e) {
                                        kendo.ui.progress($('body'), false);
                                        if (e.Errors && e.Errors.length > 0) {
                                            Common.ShowError(e.Errors.join('<br>'));
                                        } else {
                                            Common.ShowMessage('Операция успешно выполнена');
                                            Common.UI.CloseWindow('registerModalWindow', window.parent);
                                        }
                                    },
                                    error: function(e) {
                                        kendo.ui.progress($('body'), false);
                                        Common.ShowError(e.responseText);
                                    }
                                });
                            },
                            onFail: function (e) {
                                kendo.ui.progress($('body'), false);
                                Common.UI.CloseWindow('registerModalWindow', window.parent);
                            }
                        });
                    }
                },
                {
                    type: 'button',
                    text: 'Отмена',
                    icon: 'cancel',
                    click: function () {
                        Common.UI.CloseWindow('registerModalWindow', window.parent);
                    }
                }
            ]
        });
    });
</script>