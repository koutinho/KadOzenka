@using CIPJS.Models.Tenements
@using Core.Shared.Extensions
@using Core.SRD

@model LivingSpaceDto
@{
    var cultureRu = new System.Globalization.CultureInfo("ru-RU");
}

<style>
    #InsuranceProgramFlag {
        font-size: 20px;
        font-weight: bold;
    }

    #changeInInsuranceProgram {
        cursor: pointer;
        font-size: 20px;
        font-weight: bold;
        text-decoration: underline;
        pointer-events: none;
    }
    .underlineElement {
        cursor: pointer;
        text-decoration: underline;
    }
    #damageGrid.k-grid td {
        white-space: inherit;
    }
</style>
<form>
    @Html.HiddenFor(x => x.FlatId)
    <ul id="ls_panelbar" class="panelbar">
        <li id="COMON_DATA">
            <span>Общие данные</span>
            <div>
                <div class="form-horizontal col-sm-12">
                    <div class="form-group"></div>
                    <div class="form-group">
                        <div class="col-sm-2">
                            @Html.CustomLabelFor(x => x.UploadDate)
                        </div>
                        <div class="col-sm-4">
                            @Html.KendoDatePickerFor(x => x.UploadDate)
                        </div>
                        <div class="col-sm-2">
                            @Html.CustomLabel("Подлежит страхованию")
                        </div>
                        <div class="col-sm-1">
                            @Html.CustomLabelFor(x => x.InInsuranceProgramCalc, true)
                        </div>
                        <div class="col-sm-1">
                            <label id="InsuranceProgramFlag" class="@( (Model.InInsuranceProgramCalc ?? false) ? "text-green" : "text-red") control-label">@( (Model.InInsuranceProgramCalc ?? false) ? "ДА" : "НЕТ")</label>
                        </div>
                        <div class="col-sm-1">
                            @Html.CustomLabelFor(x => x.InInsuranceProgram)
                        </div>
                        <div class="col-sm-1">
                            <label id="changeInInsuranceProgram" class="@((Model.InInsuranceProgram ?? false) ? "text-green" : "text-red") control-label underlineElement">@((Model.InInsuranceProgram ?? false) ? "ДА" : "НЕТ")</label>
                            @Html.HiddenFor(x => x.InInsuranceProgram)
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="col-sm-2">
                            @Html.CustomLabelFor(x => x.Unom)
                        </div>
                        <div class="col-sm-4">
                            @Html.HiddenFor(x => x.Unom)
                            <div class="k-textbox" style="width: 100%; line-height: 32px; padding-left: 10px;">
                                @if (Model.LinkObjectMkd.HasValue)
                                {
                                    <a href="/ObjectCard?ObjId=@Model.LinkObjectMkd&RegisterViewId=Tenements&isVertical=true&useMasterPage=true" target="_parent" style="text-decoration:underline;">@(Model.Unom.HasValue ? Model.Unom.ToString() : "-")</a>
                                }
                                else
                                {
                                    <span>@Model.Unom</span>
                                }
                            </div>
                        </div>
                        <div class="col-sm-2">
                            @Html.CustomLabelFor(x => x.FlatNumber)
                        </div>
                        <div class="col-sm-4">
                            @Html.KendoTextBoxFor(x => x.FlatNumber)
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="col-sm-2">
                            @Html.CustomLabelFor(x => x.CadastralNumber)
                        </div>
                        <div class="col-sm-4">
                            @Html.KendoTextBoxFor(x => x.CadastralNumber)
                        </div>
                        <div class="col-sm-2">
                            @Html.CustomLabelFor(x => x.CadastralRegistrationDate)
                        </div>
                        <div class="col-sm-4">
                            @Html.KendoDatePickerFor(x => x.CadastralRegistrationDate)
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="col-sm-2">
                            @Html.CustomLabelFor(x => x.SpacePurpose)
                        </div>
                        <div class="col-sm-4">
                            @Html.KendoEnumDropDownListFor(x => x.SpacePurpose)
                        </div>
                        <div class="col-sm-2">
                            @Html.CustomLabelFor(x => x.SpaceType)
                        </div>
                        <div class="col-sm-4">
                            @Html.KendoEnumDropDownListFor(x => x.SpaceType)
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="col-sm-2">
                            @Html.CustomLabelFor(x => x.TotalArea)
                        </div>
                        <div class="col-sm-4">
                            @Html.KendoNumericTextBoxFor(x => x.TotalArea, 2)
                        </div>
                        <div class="col-sm-2">
                            @Html.CustomLabelFor(x => x.RoomsCount)
                        </div>
                        <div class="col-sm-4">
                            @Html.KendoNumericTextBoxFor(x => x.RoomsCount)
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="col-sm-2">
                            @Html.CustomLabelFor(x => x.Note)
                        </div>
                        <div class="col-sm-10">
                            @Html.TextBoxAreaFor(x => x.Note, 1, 2, true)
                        </div>
                    </div>
                </div>
            </div>
        </li>
        <li id="ADDRESS">
            <span>Сведения об адресе</span>
            <div>
                <div class="form-horizontal col-sm-12">
                    <div class="form-group"></div>
                    <div class="form-group">
                        <div class="col-sm-2">
                            @Html.CustomLabelFor(x => x.Okrug)
                        </div>
                        <div class="col-sm-4">
                            @Html.KendoTextBoxFor(x => x.Okrug, editMode: false)
                        </div>
                        <div class="col-sm-2">
                            @Html.CustomLabelFor(x => x.District)
                        </div>
                        <div class="col-sm-4">
                            @Html.KendoTextBoxFor(x => x.District, editMode: false)
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="col-sm-2">
                            @Html.CustomLabelFor(x => x.FullName)
                        </div>
                        <div class="col-sm-10">
                            @Html.KendoTextBoxFor(x => x.FullNameWithFlat, editMode: false)
                        </div>
                    </div>
                </div>
            </div>
        </li>
        <li id="CDATA">
            <span>Сводные данные</span>
            <div>
                <div class="form-horizontal col-sm-12">
                    <div class="form-group"></div>
                    <div class="form-group">
                        <div class="col-sm-12">
                            @await Html.PartialAsync("FlatConsolidatedData.cshtml", Model.FlatId)
                        </div>
                    </div>
                </div>
            </div>
        </li>
        <li id="RIGHTS">
            <span>Права ЕГРН</span>
            <div>
                <div class="form-horizontal col-sm-12">
                    <div class="form-group"></div>
                    <div class="form-group">
                        <div class="col-sm-12">
                            <div id="rightsGrid"></div>
                        </div>
                    </div>
                </div>
            </div>
        </li>
        <li id="SOLUTIONS">
            <span>Решения</span>
            <div>
                <div class="form-horizontal col-sm-12">
                    <div class="form-group"></div>
                    <div class="form-group">
                        <div class="col-sm-2">
                            @Html.CustomLabelFor(x => x.Nres)
                        </div>
                        <div class="col-sm-4">
                            @Html.KendoTextBoxFor(x => x.Nres, editMode: false)
                        </div>
                        <div class="col-sm-2">
                            @Html.CustomLabelFor(x => x.Dres)
                        </div>
                        <div class="col-sm-4">
                            @Html.KendoDatePickerFor(x => x.Dres, editMode: false)
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="col-sm-2">
                            @Html.CustomLabelFor(x => x.Tres)
                        </div>
                        <div class="col-sm-4">
                            @Html.KendoTextBoxFor(x => x.Tres, editMode: false)
                        </div>
                        <div class="col-sm-2">
                            @Html.CustomLabelFor(x => x.Sres)
                        </div>
                        <div class="col-sm-4">
                            @Html.KendoTextBoxFor(x => x.Sres, editMode: false)
                        </div>
                    </div>
                </div>
            </div>
        </li>
        <li id="ENCUMBRANCES">
            <span>Обременения</span>
            <div>
                <div class="form-horizontal col-sm-12">
                    <div class="form-group"></div>
                    <div class="form-group">
                        <div class="col-sm-2">
                            @Html.CustomLabelFor(x => x.ArOsn)
                        </div>
                        <div class="col-sm-4">
                            @Html.KendoTextBoxFor(x => x.ArOsn, editMode: false)
                        </div>
                        <div class="col-sm-2">
                            @Html.CustomLabelFor(x => x.ArDt)
                        </div>
                        <div class="col-sm-4">
                            @Html.KendoDatePickerFor(x => x.ArDt,editMode:false)
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="col-sm-2">
                            @Html.CustomLabelFor(x => x.ArDtvv)
                        </div>
                        <div class="col-sm-4">
                            @Html.KendoDatePickerFor(x => x.ArDtvv,editMode:false)
                        </div>
                        <div class="col-sm-2">
                        </div>
                        <div class="col-sm-4">
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="col-sm-2">
                            @Html.CustomLabelFor(x => x.ArOsnsn)
                        </div>
                        <div class="col-sm-4">
                            @Html.KendoTextBoxFor(x => x.ArOsnsn, editMode: false)
                        </div>
                        <div class="col-sm-2">
                            @Html.CustomLabelFor(x => x.ArDtsn)
                        </div>
                        <div class="col-sm-4">
                            @Html.KendoDatePickerFor(x => x.ArDtsn, editMode: false)
                        </div>
                    </div>
                </div>
            </div>
        </li>
        @for (int i = 0; i < Model.Fsps.Count; i++)
        {
            <li id="@("AFSP" + Model.Fsps[i].Id)">
                <span>@Model.Fsps[i].Title</span>
                <div>
                    <div class="form-horizontal col-sm-12">
                        <div class="form-group"></div>
                        <div class="form-group">
                            <div class="col-sm-12">
                                <div class="ajax-data-loading" data-url="@Url.Content("~/Fsp/PartialDetails")" data-param-id="@Model.Fsps[i].Id" data-loader="true"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </li>
        }
        <li id="DAMAGE">
            <span>Дела по расчету ущерба</span>
            <div>
                <div class="form-horizontal col-sm-12">
                    <div class="form-group"></div>
                    <div class="form-group">
                        <div class="col-sm-12">
                            <div id="damageGrid"></div>
                        </div>
                    </div>
                </div>
            </div>
        </li>
        <li id="PAYS">
            <span>Страховые выплаты</span>
            <div>
                <div class="form-horizontal col-sm-12">
                    <div class="form-group"></div>
                    <div class="form-group">
                        <div class="col-sm-12">
                            <div id="payToGrid"></div>
                        </div>
                    </div>
                </div>
            </div>
        </li>
        <li id="FAILURES">
            <span>Отказы от страховых выплат</span>
            <div>
                <div class="form-horizontal col-sm-12">
                    <div class="form-group"></div>
                    <div class="form-group">
                        <div class="col-sm-12">
                            <div id="noPayGrid"></div>
                        </div>
                    </div>
                </div>
            </div>
        </li>
        <li id="COMMENTS">
            <span>Комментарии</span>
            <div>
                <div class="form-horizontal col-sm-12">
                    <div class="form-group"></div>
                    <div class="form-group">
                        <div class="col-sm-12">
                            <div class="ajax-data-loading" data-request-type="GET" data-url="@Url.Content("~/Comment/Index")" data-param-reestrId="317" data-param-objectId="@Model.FlatId" data-param-isReadOnly="true" data-loader="true"></div>
                        </div>
                    </div>
                </div>
            </div>
        </li>
        <li id="ADD_BTI" style="display: none;">
            <span>Решения по помещению / информация по обременению</span>
            <div>
                <div class="form-horizontal col-sm-12">
                    <div class="form-group"></div>
                    <div class="form-group">
                        <div class="col-sm-2">
                            @Html.CustomLabelFor(x => x.Tres)
                        </div>
                        <div class="col-sm-4">
                            @Html.KendoTextBoxFor(x => x.Tres, editMode: false)
                        </div>
                        <div class="col-sm-2">
                            @Html.CustomLabelFor(x => x.Sres)
                        </div>
                        <div class="col-sm-4">
                            @Html.KendoTextBoxFor(x => x.Sres, editMode: false)
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="col-sm-2">
                            @Html.CustomLabelFor(x => x.Dres)
                        </div>
                        <div class="col-sm-4">
                            @Html.KendoDatePickerFor(x => x.Dres, editMode: false)
                        </div>
                        <div class="col-sm-2">
                            @Html.CustomLabelFor(x => x.Nres)
                        </div>
                        <div class="col-sm-4">
                            @Html.KendoTextBoxFor(x => x.Nres, editMode: false)
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="col-sm-2">
                            @Html.CustomLabelFor(x => x.ArDtvv)
                        </div>
                        <div class="col-sm-4">
                            @Html.KendoDatePickerFor(x => x.ArDtvv, editMode: false)
                        </div>
                        <div class="col-sm-2">
                            @Html.CustomLabelFor(x => x.ArDt)
                        </div>
                        <div class="col-sm-4">
                            @Html.KendoDatePickerFor(x => x.ArDt, editMode: false)
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="col-sm-2">
                            @Html.CustomLabelFor(x => x.ArOsn)
                        </div>
                        <div class="col-sm-4">
                            @Html.KendoTextBoxFor(x => x.ArOsn, editMode: false)
                        </div>
                        <div class="col-sm-2">
                            @Html.CustomLabelFor(x => x.ArDtsn)
                        </div>
                        <div class="col-sm-4">
                            @Html.KendoDatePickerFor(x => x.ArDtsn, editMode: false)
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="col-sm-2">
                            @Html.CustomLabelFor(x => x.ArOsnsn)
                        </div>
                        <div class="col-sm-4">
                            @Html.KendoTextBoxFor(x => x.ArOsnsn, editMode: false)
                        </div>
                    </div>
                </div>
            </div>
        </li>
    </ul>
    <div class="static-nav">
        <nav id="navigation-menu">
            <a href="#COMON_DATA">Общие данные</a>
            <a href="#ADDRESS">Сведения об адресе</a>
            <a href="#CDATA">Сводные данные</a>
            <a href="#RIGHTS">Права ЕГРН <span class="label label-count"></span></a>
            <a href="#SOLUTIONS">Решения</a>
            <a href="#ENCUMBRANCES">Обременения</a>
            <a href="@("#AFSP" + (Model.Fsps.IsNotEmpty() ? Model.Fsps[0].Id : 0))">ФСП <span class="label label-count">@Model.Fsps.Count</span></a>
            <a href="#DAMAGE">Дела по расчету ущерба <span class="label label-count"></span></a>
            <a href="#PAYS">Страховые выплаты <span class="label label-count"></span></a>
            <a href="#FAILURES">Отказы от страховых выплат <span class="label label-count"></span></a>
            <a href="#COMMENTS" nav-name="comments">Комментарии <span class="label label-count"></span></a>
        </nav>
        <div id="toolbar" style="position:absolute; bottom: 20px; width: 95%;"></div>

        <fieldset style="margin-top: 20px;">
            <div class="row" style="display:@{ if (Model.FspFlagManyObj) { <text>block</text> } else { <text>none</text> } };margin-bottom: 0;">
                <div class="col-xs-12 label-value" style="text-align: center;">
                    @Html.Label("FspFlagManyObjSummary", "ФСП на несколько квартир", new { @class = "text-red", style = "font-size: 16px;" })
                </div>
            </div>
            <div class="row" style="text-align: center; border: 1px solid #99979c; border-radius: 6px;">
                <div class="col-xs-12 label-value" style="font-weight: bold;">
                    @Html.CustomLabel("МФЦ")
                </div>
                <div class="col-xs-12 label-value">
                    @Html.CustomLabel(DateTime.Now.AddMonths(-1).ToString("MMMM yyyy"))
                </div>
                <div class="col-xs-12 label-value" style="text-align: left; padding-left: 4px;">
                    @Html.CustomLabel("Начислено:")
                </div>
                <div class="col-xs-12 label-value">
                    <div class="col-xs-6 label-value" style="text-align: left; padding-left: 24px;">
                        <span class="k-icon k-i-sum"></span>
                        @Html.CustomLabel(":")
                        @Html.CustomLabel((Model.AccruedSumCurrent.HasValue ? Model.AccruedSumCurrent.Value.ToString("N2") : "0,00"), classCSS: Model.AccruedSumCurrent > 0 ? "text-green" : "text-red")
                    </div>
                    <div class="col-xs-6 label-value" style="text-align: left; padding-left: 24px;">
                        @Html.CustomLabel("S:")
                        @Html.CustomLabel((Model.AccruedOplCurrent.HasValue ? Model.AccruedOplCurrent.Value.ToString("N2") : "0,00"), classCSS: Model.AccruedOplCurrent > 0 ? "text-green" : "text-red")
                    </div>
                </div>
                <div class="col-xs-12 label-value" style="text-align: left; padding-left: 4px;">
                    @Html.CustomLabel("Оплачено:")
                </div>
                <div class="col-xs-12 label-value">
                    <div class="col-xs-6 label-value" style="text-align: left; padding-left: 24px;">
                        <span class="k-icon k-i-sum"></span>
                        @Html.CustomLabel(":")
                        @Html.CustomLabel((Model.CreditedSumCurrent.HasValue ? Model.CreditedSumCurrent.Value.ToString("N2") : "0,00"), classCSS: Model.CreditedSumCurrent > 0 ? "text-green" : "text-red")
                    </div>
                    <div class="col-xs-6 label-value" style="text-align: left; padding-left: 24px;">
                        @Html.CustomLabel("S:")
                        @Html.CustomLabel((Model.CreditedOplCurrent.HasValue ? Model.CreditedOplCurrent.Value.ToString("N2") : "0,00"), classCSS: Model.CreditedOplCurrent > 0 ? "text-green" : "text-red")
                    </div>
                </div>
                <div class="col-xs-12 label-value">
                </div>
                <div class="col-xs-12 label-value">
                    @Html.CustomLabel(DateTime.Now.AddMonths(-2).ToString("MMMM yyyy"))
                </div>
                <div class="col-xs-12 label-value" style="text-align: left; padding-left: 4px;">
                    @Html.CustomLabel("Начислено:")
                </div>
                <div class="col-xs-12 label-value">
                    <div class="col-xs-6 label-value" style="text-align: left; padding-left: 24px;">
                        <span class="k-icon k-i-sum"></span>
                        @Html.CustomLabel(":")
                        @Html.CustomLabel((Model.AccruedSumLast.HasValue ? Model.AccruedSumLast.Value.ToString("N2") : "0,00"), classCSS: Model.AccruedSumLast > 0 ? "text-green" : "text-red")
                    </div>
                    <div class="col-xs-6 label-value" style="text-align: left; padding-left: 24px;">
                        @Html.CustomLabel("S:")
                        @Html.CustomLabel((Model.AccruedOplLast.HasValue ? Model.AccruedOplLast.Value.ToString("N2") : "0,00"), classCSS: Model.AccruedOplLast > 0 ? "text-green" : "text-red")
                    </div>
                </div>
                <div class="col-xs-12 label-value" style="text-align: left; padding-left: 4px;">
                    @Html.CustomLabel("Оплачено:")
                </div>
                <div class="col-xs-12 label-value">
                    <div class="col-xs-6 label-value" style="text-align: left; padding-left: 24px;">
                        <span class="k-icon k-i-sum"></span>
                        @Html.CustomLabel(":")
                        @Html.CustomLabel((Model.CreditedSumLast.HasValue ? Model.CreditedSumLast.Value.ToString("N2") : "0,00"), classCSS: Model.CreditedSumLast > 0 ? "text-green" : "text-red")
                    </div>
                    <div class="col-xs-6 label-value" style="text-align: left; padding-left: 24px;">
                        @Html.CustomLabel("S:")
                        @Html.CustomLabel((Model.CreditedOplLast.HasValue ? Model.CreditedOplLast.Value.ToString("N2") : "0,00"), classCSS: Model.CreditedOplLast > 0 ? "text-green" : "text-red")
                    </div>
                </div>
                <div class="col-xs-12 label-value">
                </div>
            </div>
        </fieldset>
        <div id="wndReferenceDetails" />
    </div>
</form>
<script>
    $(function () {
        var anchor = window.location.hash;
        if (anchor && $(anchor).length) {
            setTimeout(function () {
                $('html,body').animate({ scrollTop: $(anchor).offset().top }, 200)
            }, 500);
        }

        $("#navigation-menu a").mPageScroll2id({
            highlightSelector: "#navigation-menu a"
        });

        $('.static-nav a').on('click', function (e) {
            e.preventDefault();
            var elementId = $(e.target).attr('href');
            if (elementId && $(elementId).offset()) {
                $('html,body').animate({ scrollTop: $(elementId).offset().top - 9 }, 500);
            }
        });

        var panelbar = $('#ls_panelbar').kendoPanelBar().data('kendoPanelBar');
        panelbar.expand('li');

        $('#damageGrid').kendoGrid({
            scrollable: false,
            resizable: true,
            columns: [
                {
                    field: 'CaseNumber',
                    template: '<a href="@Url.Content("~/ObjectCard/Index")?ObjId=#:DamageId#&RegisterViewId=DamageAnalysisGP&isVertical=true&useMasterPage=true" target="_blank">#:CaseNumber#</a>',
                    title: 'Номер дела в ОПС',
                    attributes: { style: "text-align: center;" }
                },
                {
                    field: 'CaseDate',
                    type: "date",
                    format: "{0:dd.MM.yyyy}",
                    title: 'Дата дела',
                    attributes: { style: "text-align: center;" }
                },
                {
                    field: 'InsuranceCompany',
                    title: 'Страховая компания',
                    attributes: { style: "text-align: center;" }
                },
                {
                    field: 'DamageDate',
                    type: "date",
                    format: "{0:dd.MM.yyyy}",
                    title: 'Дата ущерба',
                    attributes: { style: "text-align: center;" }
                },
                {
                    field: 'DamageAmount',
                    format: "{0:n2}",
                    title: 'Сумма ущерба',
                    attributes: { style: "text-align: center;" }
                },
                {
                    field: 'DamageReason',
                    title: 'Причина ущерба'
                }
            ],
            dataBound: function () {
                if (!$('a[href="#DAMAGE"] span').text()) {
                    $('a[href="#DAMAGE"] span').text(this.dataItems().length);
                }
            },
            dataSource: {
                transport: {
                    read: {
                        url: '@Url.Action("Damages_Read", "Tenements")',
                        data: { flatId: '@Model.FlatId' },
                        contentType: 'application/json; charset=utf-8',
                        dataType: 'json'
                    }
                }
            }
        });

        $('#payToGrid').kendoGrid({
            scrollable: false,
            resizable: true,
            columns: [
                {
                    field: 'ContractNumber',
                    title: 'Номер договора',
                    attributes: { style: "text-align: center;" }
                },
                {
                    field: 'BeginDate',
                    type: "date",
                    format: "{0:dd.MM.yyyy}",
                    title: 'Дата начала действия договора',
                    attributes: { style: "text-align: center;" }
                },
                {
                    field: 'InsuranceCompany',
                    title: 'Страховая компания',
                    attributes: { style: "text-align: center;" }
                },
                {
                    field: 'DamageAmount',
                    format: "{0:n2}",
                    title: 'Размер ущерба',
                    attributes: { style: "text-align: center;" }
                },
                {
                    field: 'RefundAmount',
                    format: "{0:n2}",
                    title: 'Сумма возмещения',
                    attributes: { style: "text-align: center;" }
                },
                {
                    field: 'HeldPartAmount',
                    format: "{0:n2}",
                    title: 'Размер удержанной части',
                    attributes: { style: "text-align: center;" }
                },
                {
                    field: 'SkNumber',
                    title: 'Номер пп СК',
                    attributes: { style: "text-align: center;" }
                },
                {
                    field: 'SkDate',
                    type: "date",
                    format: "{0:dd.MM.yyyy}",
                    title: 'Дата пп СК',
                    attributes: { style: "text-align: center;" }
                }
            ],
            dataBound: function () {
                if (!$('a[href="#PAYS"] span').text()) {
                    $('a[href="#PAYS"] span').text(this.dataItems().length);
                }
            },
            dataSource: {
                transport: {
                    read: {
                        url: '@Url.Action("PayTos_Read", "Tenements")',
                        data: { flatId: '@Model.FlatId' },
                        contentType: 'application/json; charset=utf-8',
                        dataType: 'json'
                    }
                }
            }
        });

        $('#noPayGrid').kendoGrid({
            scrollable: false,
            resizable: true,
            columns: [
                {
                    field: 'ContractNumber',
                    title: 'Номер договора',
                    attributes: { style: "text-align: center;" }
                },
                {
                    field: 'BeginDate',
                    type: "date",
                    format: "{0:dd.MM.yyyy}",
                    title: 'Дата начала действия договора',
                    attributes: { style: "text-align: center;" }
                },
                {
                    field: 'InsuranceCompany',
                    title: 'Страховая компания',
                    attributes: { style: "text-align: center;" }
                },
                {
                    field: 'EventDate',
                    type: "date",
                    format: "{0:dd.MM.yyyy}",
                    title: 'Дата страхового события',
                    attributes: { style: "text-align: center;" }
                },
                {
                    field: 'Reason',
                    title: 'Причина отказа в выплате',
                    attributes: { style: "text-align: center;" }
                }
            ],
            dataBound: function () {
                if (!$('a[href="#FAILURES"] span').text()) {
                    $('a[href="#FAILURES"] span').text(this.dataItems().length);
                }
            },
            dataSource: {
                transport: {
                    read: {
                        url: '@Url.Action("NoPays_Read", "Tenements")',
                        data: { flatId: '@Model.FlatId' },
                        contentType: 'application/json; charset=utf-8',
                        dataType: 'json'
                    }
                }
            }
        });

        $('#rightsGrid').kendoGrid({
            toolbar: [
                { name: "excel" }
            ],
            scrollable: false,
            resizable: true,
            columns: [
                {
                    field: 'Type',
                    title: 'Тип объекта'
                },
                {
                    field: 'Area',
                    title: 'Площадь объекта ЕГРН'
                },
                {
                    field: 'CadastralNumber',
                    title: 'Кадастровый номер'
                },
                {
                    field: 'RightKind',
                    title: 'Вид права'
                },
                {
                    field: 'Number',
                    title: 'Номер ЕГРН'
                },
                {
                    field: 'BeginDate',
                    template: '#:BeginDate?kendo.toString(kendo.parseDate(BeginDate), "dd.MM.yyyy"):""#',
                    title: 'Дата начала права'
                },
                {
                    field: 'EndDate',
                    template: '#:EndDate?kendo.toString(kendo.parseDate(EndDate), "dd.MM.yyyy"):""#',
                    title: 'Дата окончания права'
                },
                {
                    field: 'ShareSize',
                    title: 'Размер доли (число)'
                },
                {
                    field: 'ShareSizeText',
                    title: 'Размер доли (текст)'
                },
                {
                    field: 'ShareArea',
                    title: 'Площадь доли'
                },
                {
                    field: 'Note',
                    title: 'Примечание'
                }
            ],
            dataBound: function () {
                if (!$('a[href="#RIGHTS"] span').text()) {
                    var items = this.dataItems(),
                        count = 0;

                    items.forEach(function (item) {
                        if (!item.EndDate || item.EndDate == null) count++;
                    });

                    $('a[href="#RIGHTS"] span').text(count);
                }
            },
            dataSource: {
                transport: {
                    read: {
                        url: '@Url.Action("EgrnRights_Read", "Tenements")',
                        data: { flatId: '@Model.FlatId' },
                        contentType: 'application/json; charset=utf-8',
                        dataType: 'json'
                    }
                }
            },
            excelExport: function (e) {
                var unom = '@Model.Unom';
                if (unom == undefined || unom == '') {
                    unom = '@Model.CadastralNumber'.replace(/:/g, '-');
                }
                if (unom != undefined && unom.length > 0) {
                    unom += '_';
                }
                e.workbook.fileName = 'Права_ЕГРН_' + unom + kendo.toString(new Date(), 'dd.MM.yyyy') + '.xlsx';
                KendoExtension.ExportGridWithTemplatesContent(e);
            },
            messages: {
                commands: {
                    excel: 'Экспорт в Excel'
                }
            }
        });

        var toolbar = $('#toolbar').kendoToolBar({
            items: [
            @if (SRDSession.Current.CheckAccessToFunction(ObjectModel.SRD.SRDCoreFunctions.INSUR_OBJ_FLAT_WRITE))
            {
                @Html.Raw(@"{
                type: 'button',
                text: '',
                icon: 'pencil',
                id: 'edit',
                click: function() {
                        KendoExtension.ToggleEditMode(true);
                    $('#changeInInsuranceProgram').css('pointer-events', 'auto');
                        toolbar.hide($('#edit'));
                        toolbar.show($('#save'));
                    }
                },
                {
                type: 'button',
                text: '',
                icon: 'save',
                id: 'save',
                hidden: true,
                click: function() {
                        Common.ClearNotification();
                        kendo.ui.progress($('body'), true);

                    $.ajax({
                        type: 'POST',
                        url: '" + @Url.Action("LivingSpace", "Tenements") + @"',
                        data: $('form').serialize(),
                        success: function(e) {
                                if (e.Errors && e.Errors.length > 0) {
                                    Common.ShowError(e.Errors);
                                } else {
                                    Common.ShowMessage('Карточка успешно сохранена');
                                    KendoExtension.ToggleEditMode(false);
                                $('#changeInInsuranceProgram').css('pointer-events', 'none');
                                $('#flatConsolidationGrid').data('kendoGrid').dataSource.read();
                                    toolbar.hide($('#save'));
                                    toolbar.show($('#edit'));
                                }

                                kendo.ui.progress($('body'), false);
                            }, error: function(e) {
                                Common.ShowError(e.responseText)
                                kendo.ui.progress($('body'), false);
                            }
                        });
                    }
                },");
                }
                {
                type: 'button',
                    imageUrl: '/images/audit.png',
                    id: 'audit',
                    hidden: false,
                    click: function () {
                        var wndReferenceDetails = $("#wndReferenceDetails").kendoWindow({
                        resizable: false,
                            draggable: false,
                            actions: ["Close"],
                            modal: true,
                            content: "/ReferenceDetails/Index?objectId=" + @Model.FlatId + "&registerId=317"
                        });

                        wndReferenceDetails.data("kendoWindow").open().maximize();
                    }
                }
            ]
        }).data('kendoToolBar');

        $('#changeInInsuranceProgram').click(function () {
            Common.UI.ShowConfirm({
                title: 'Подтверждение',
                content: 'Внимание! Вы подтверждаете изменение статуса участия в программе страхования?',
                onSuccess: function () {
                    if ($('[name="InInsuranceProgram"]').val() == 'True') {
                        $('#changeInInsuranceProgram').text('НЕТ');
                        $('#changeInInsuranceProgram').removeClass('text-green');
                        $('#changeInInsuranceProgram').addClass('text-red');
                        $('[name="InInsuranceProgram"]').val('False');
                    } else {
                        $('#changeInInsuranceProgram').text('ДА');
                        $('#changeInInsuranceProgram').removeClass('text-red');
                        $('#changeInInsuranceProgram').addClass('text-green');
                        $('[name="InInsuranceProgram"]').val('True');
                    }
                }
            });
        });

        $('#toolbar').kendoTooltip({
            filter: "a.k-button",
            content: function (e) {
                switch ($(e.target).attr('id')) {
                    case "edit":
                        return "Редактировать";
                    case "save":
                        return "Сохранить";
                    case "audit":
                        return "Аудит";
                    case "print":
                        return "Печать";
                }
            },
            position: "top",
            autoHide: true,
            showAfter: 500
        });
    });
</script>

<style>
    fieldset label {
        font-size: 12px !important;
        margin-bottom: 0px;
    }

    .static-nav > fieldset label {
        font-weight: normal !important;
    }
</style>