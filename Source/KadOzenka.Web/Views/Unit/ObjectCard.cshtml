@using KadOzenka.Web.Models.Unit
@model KadOzenka.Web.Models.Task.UnitDto

<div>
    @Html.HiddenFor(x => x.Id)
    @Html.HiddenFor(x => x.ObjectId)
    @Html.HiddenFor(x => x.TaskId)
    @Html.HiddenFor(x => x.CostRosreestrId)

    <ul id="ls_panelbar" class="panelbar">
        <li id="MainData" data-expand>
            <span>Основные данные</span>
            <div>
                <div class="form-horizontal col-sm-12">
                    <div class="form-group">
                        <div class="col-sm-2">
                            @Html.CustomLabelFor(x => x.Tour)
                        </div>
                        <div class="col-sm-4">
                            @Html.KendoDropDownListFor(x => x.TourId, "GetRatingTours", "Tour")
                        </div>                    
                        <div class="col-sm-2">
                            @Html.CustomLabelFor(x => x.NoteType)
                        </div>
                        <div class="col-sm-4">
                            @Html.KendoEnumDropDownListFor(x => x.NoteType, isReadonly: true)
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="col-sm-2">
                            @Html.CustomLabelFor(x => x.DocumentId)
                        </div>
                        <div class="col-sm-4">                            
                            @Html.KendoTextBoxFor(x => x.Document, isReadonly: true)
                        </div>                    
                        <div class="col-sm-2">
                            @Html.CustomLabelFor(x => x.TaskCreationDate)
                        </div>
                        <div class="col-sm-4">
                            @Html.KendoDatePickerFor(x => x.TaskCreationDate, isReadonly: true)
                        </div>
                    </div>
                </div>
            </div>
        </li>

        <li id="Unit" data-expand>
            <span>Единица оценки</span>
            <div>
                <div class="form-horizontal col-sm-12">
                    <div class="form-group">
                        <div class="col-sm-2">
                            @Html.CustomLabelFor(x => x.BuildingCadastralNumber)
                        </div>
                        <div class="col-sm-4">
                            @Html.KendoTextBoxFor(x => x.BuildingCadastralNumber, isReadonly: true)
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="col-sm-2">
                            @Html.CustomLabelFor(x => x.CadastralNumber)
                        </div>
                        <div class="col-sm-4">
                            @Html.KendoTextBoxFor(x => x.CadastralNumber, isReadonly: true)
                        </div>                    
                        <div class="col-sm-2">
                            @Html.CustomLabelFor(x => x.CadastralBlock)
                        </div>
                        <div class="col-sm-4">
                            @Html.KendoTextBoxFor(x => x.CadastralBlock, isReadonly: true)
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="col-sm-2">
                            @Html.CustomLabelFor(x => x.PropertyType)
                        </div>
                        <div class="col-sm-4">
                            @Html.KendoEnumDropDownListFor(x => x.PropertyType, isReadonly: true)
                        </div>                    
                        <div class="col-sm-2">
                            @Html.CustomLabelFor(x => x.Square)
                        </div>
                        <div class="col-sm-4">
                            @Html.KendoNumericTextBoxFor(x => x.Square, isReadonly: true, precision: 2)
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="col-sm-2">
                            @Html.CustomLabelFor(x => x.Status)
                        </div>
                        <div class="col-sm-4">
                            @Html.KendoEnumDropDownListFor(x => x.Status, isReadonly: true)
                        </div>                    
                        <div class="col-sm-2">
                            @Html.CustomLabelFor(x => x.UnitCreationDate)
                        </div>
                        <div class="col-sm-4">
                            @Html.KendoDatePickerFor(x => x.UnitCreationDate, isReadonly: true)
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="col-sm-2">
                            @Html.CustomLabelFor(x => x.AssessmentDate)
                        </div>
                        <div class="col-sm-4">
                            @Html.KendoDatePickerFor(x => x.AssessmentDate, isReadonly: true)
                        </div>
                    </div>
                </div>
            </div>
        </li>

        <li id="Result" data-expand>
            <span>Результат оценки</span>
            <div>
                <div class="form-horizontal col-sm-12">
                    <div class="form-group">
                        <div class="col-sm-2">
                            @Html.CustomLabelFor(x => x.GroupNumber)
                        </div>
                        <div class="col-sm-4">
                            @Html.KendoTextBoxFor(x => x.GroupNumber, isReadonly: true)
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="col-sm-2">
                            @Html.CustomLabelFor(x => x.GroupName)
                        </div>
                        <div class="col-sm-4">
                            @Html.KendoTextBoxFor(x => x.GroupName)
                        </div>
                        <div class="col-sm-2">
                            @Html.CustomLabelFor(x => x.UpksPre)
                        </div>
                        <div class="col-sm-4">
                            @Html.KendoNumericTextBoxFor(x => x.UpksPre, isReadonly: true, precision: 2)
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="col-sm-2">
                            @Html.CustomLabelFor(x => x.CadastralCostPre)
                        </div>
                        <div class="col-sm-4">
                            @Html.KendoNumericTextBoxFor(x => x.CadastralCostPre, isReadonly: true, precision:2)
                        </div>
                        <div class="col-sm-2">
                            @Html.CustomLabelFor(x => x.Upks)
                        </div>
                        <div class="col-sm-4">
                            @Html.KendoNumericTextBoxFor(x => x.Upks, isReadonly: true, precision: 2)
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="col-sm-2">
                            @Html.CustomLabelFor(x => x.CadastralCost)
                        </div>
                        <div class="col-sm-4">
                            @Html.KendoNumericTextBoxFor(x => x.CadastralCost, isReadonly: true, precision: 2)
                        </div>
                        <div class="col-sm-2">
                            @Html.CustomLabelFor(x => x.StatusRepeatCalc)
                        </div>
                        <div class="col-sm-4">
                            @Html.KendoEnumDropDownListFor(x => x.StatusRepeatCalc, isReadonly: true)
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="col-sm-2">
                            @Html.CustomLabelFor(x => x.StatusResultCalc)
                        </div>
                        <div class="col-sm-4">
                            @Html.KendoEnumDropDownListFor(x => x.StatusResultCalc, isReadonly: true)
                        </div>
                        <div class="col-sm-2">
                            @Html.CustomLabelFor(x => x.ParentCalcType)
                        </div>
                        <div class="col-sm-4">
                            @Html.KendoEnumDropDownListFor(x => x.ParentCalcType, isReadonly: true)
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="col-sm-2">
                            @Html.CustomLabelFor(x => x.ParentCalcNumber)
                        </div>
                        <div class="col-sm-4">
                            @Html.KendoTextBoxFor(x => x.ParentCalcNumber, isReadonly: true)
                        </div>
                        <div class="col-sm-2">
                            @Html.CustomLabelFor(x => x.ResponseDocId)
                        </div>
                        <div class="col-sm-4">
                            @Html.KendoTextBoxFor(x => x.ResponseDoc, isReadonly: true)
                        </div>
                    </div>
                </div>
            </div>
        </li>

        <li id="GKN" data-expand>
            <span>Данные стоимости ГКН</span>
            <div>
                <div class="form-horizontal col-sm-12">
                    <div class="form-group">
                        <div class="col-sm-2">
                            @Html.CustomLabelFor(x => x.Datevaluation)
                        </div>
                        <div class="col-sm-4">
                            @Html.KendoDatePickerFor(x => x.Datevaluation, isReadonly: true)
                        </div>                    
                        <div class="col-sm-2">
                            @Html.CustomLabelFor(x => x.CostValue)
                        </div>
                        <div class="col-sm-4">
                            @Html.KendoNumericTextBoxFor(x => x.CostValue, isReadonly: true, precision: 2)
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="col-sm-2">
                            @Html.CustomLabelFor(x => x.DocName)
                        </div>
                        <div class="col-sm-10">
                            @Html.KendoTextBoxFor(x => x.DocName, isReadonly: true)
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="col-sm-2">
                            @Html.CustomLabelFor(x => x.DocNumber)
                        </div>
                        <div class="col-sm-4">
                            @Html.KendoTextBoxFor(x => x.DocNumber, isReadonly: true)
                        </div>
                        <div class="col-sm-2">
                            @Html.CustomLabelFor(x => x.DocDate)
                        </div>
                        <div class="col-sm-4">
                            @Html.KendoDatePickerFor(x => x.DocDate, isReadonly: true)
                        </div>
                    </div>
                </div>
            </div>
        </li>

        <li id="Explication" data-expand>
            <span>Экспликация площадей</span>
            <div>
                <div class="form-horizontal col-sm-12">
                    <div id="explicationGrid"></div>
                </div>
            </div>
        </li>

        <li id="Factors" data-expand>
            <span>Факторы стоимости</span>
            <div>
                <div class="form-horizontal col-sm-12">
                    <div id="factorsGrid"></div>
                </div>
            </div>
        </li>
    </ul>

    <div class="static-nav">
        <nav id="navigation-menu">
            <a href="#MainData">Основные данные</a>
            <a href="#Unit">Единица оценки</a>
            <a href="#Result">Результат оценки</a>
            <a href="#GKN">Данные стоимости ГКН</a>
            <a href="#Explication">Экспликация площадей</a>
            <a href="#Factors">Факторы стоимости</a>
        </nav>
        <div id="toolbar"></div>
    </div>
</div>



<script type="text/x-kendo-template" id="factorsGridToolbarTemplate">
    <div class="factorsGridToolbarContainer">
        <div style="display: flex;">
            @*<label class="factors-switch-label" for="factors-dropdownlist">Вид отображения факторов</label>*@
            <input id="factors-dropdownlist" />
            <div style="display: flex;margin-left:1%;">
                <input type="checkbox" id="factorsWithValueCheckBox" class="k-checkbox">
                <label class="k-checkbox-label" for="factorsWithValueCheckBox">Заполненные</label>
            </div>
        </div>
       
    </div>
</script>


<script>
    $(document).ready(function () {
        var panelbar = $('#ls_panelbar').kendoPanelBar().data('kendoPanelBar');
        panelbar.expand('li[data-expand]');

        $("#navigation-menu a").mPageScroll2id({
            highlightSelector: "#navigation-menu a"
        });

        $("#toolbar").kendoToolBar({
            items: [
                {
                    type: 'button',
                    id: 'history',
                    attributes: { style: 'padding: 10px' },
                    text: 'История расчета',
                    click: function () {
                        window.open('@Url.Action("UnitHistory", "Unit")' + '?unitId=@Model.Id');
                    },
                    icon: 'track-changes',
                    overflow: 'never'
                }
            ]
        }).data('kendoToolBar');

        $('#toolbar').kendoTooltip({
            filter: "a.k-button",
            content: function (e) {
                switch ($(e.target).attr('id')) {
                    case "history":
                        return "История расчета";
                    case "print":
                        return "Печать";
                }
            },
            position: "top",
            autoHide: true,
            showAfter: 500
        });

        $('#explicationGrid').kendoGrid({
            dataSource: {
                transport: {
                    read: {
                        url: '@Url.Action("GetExplication", "Task")',
                        contentType: 'application/json; charset=utf-8',
                        data: { id: '@Model.Id' },
                        dataType: 'json'
                    }
                }
            },
            columns: [
                {
                    field: 'Group', title: 'Группа'
                },
                {
                    field: 'Square', title: 'Площадь', format: '{0:n}'
                },
                {
                    field: 'Upks', title: 'УПКС', format: '{0:n}'
                },
                {
                    field: 'Kc', title: 'КС', format: '{0:n}'
                },
                {
                    field: 'Analog', title: 'Аналог'
                }
            ],

        });

        $('#factorsGrid').kendoGrid({
            dataSource: {
                transport: {
                    read: {
                        url: '@Url.Action("GetUnitFactors", "Task")',
                        contentType: 'application/json; charset=utf-8',
                        data: { id: '@Model.Id' },
                        dataType: 'json'
                    }
                }
            },
            columns: [
                {
                    field: 'FactorName',
                    title: 'Фактор',
                    filterable: false
                },
                {
                    field: 'FactorValue', title: 'Значение'
                }
            ],
            toolbar: kendo.template($("#factorsGridToolbarTemplate").html()),
            pageable: {
                pageSize: 10
            },
            filterable: {
                extra: false,
                operators: {
                    string: {
                        startswith: "Начинается с",
                        eq: "Равно",
                        neq: "Не равно"
                    }
                }
            }
        });

        var unitFactorsShowTypesDataSource = new kendo.data.DataSource({
            transport: {
                read: {
                    url: '@Html.Raw(Url.Action("GetUnitFactorsShowTypes", "Task"))',
                    dataType: "json"
                }
            }
        });
        $("#factors-dropdownlist").kendoDropDownList({
            dataSource: unitFactorsShowTypesDataSource,
            dataTextField: "Text",
            dataValueField: "Value",
            change: function(e) {
                getFactors();
            },
            value: @((long)UnitFactorsShowType.ModelFactors)
        });

        $('#factorsWithValueCheckBox').on('change', getFactors);
    });


    function getFactors() {
        var unitFactorsShowType = $("#factors-dropdownlist").data('kendoDropDownList').value();
        var isFilledFactorsChecked = $('#factorsWithValueCheckBox').prop('checked');
        var grid = $('#factorsGrid').data("kendoGrid");
        grid.dataSource.transport.options.read.data["unitFactorsShowType"] = unitFactorsShowType;
        grid.dataSource.transport.options.read.data["isShowOnlyFilledFactors"] = isFilledFactorsChecked;
        grid.dataSource.read();
    }
</script>




<style>
    .form-horizontal .control-label {
        text-align: left;
        font-weight: normal;
    }

    span.k-header {
        margin-bottom: 10px !important;
    }

    #toolbar {
        position: absolute;
        bottom: 20px;
        width: 95%;
    }

    .factors-switch-label {
        margin-right: 5px;
        font-weight: 300;
        color: #0a1124;
        align-self: center;
    }
    .k-checkbox-label {
        align-self: center;
    }

    .factorsGridToolbarContainer span.k-widget.k-dropdown {
        width: auto;
    }
</style>