<div class="flex-content">
    <!-- Модальное окно для добавления Тура -->
    <div id="tourAdditionModal" style="display: none;">
        <div class="form-group" style="padding: 5px">
            <label for="addTourInput"> Наименование </label>
            <input id="addTourInput" class="form-control" required="required" type="number" name="addTour"/>
            <button class="btn btn-default" style="margin-top: 10px;" id="saveTour"> Сохранить </button>
        </div>
    </div>
    
    <!-- Модальное окно для добавления Группы/Подгруппы -->
    <div id="groupAdditionModal" style="display: none; padding: 5%;">
        <div class="form-group">
            <div class="row">
                <div class="col-sm-4">
                    <label>Тур:</label>
                </div>
                <div class="col-sm-7 col-sm-offset-1">
                    <label id="tourYear"></label>
                </div>
            </div>
        </div>
        <div class="form-group">
            <div class="row">
                <div class="col-sm-4">
                    <label>Основная группа:</label>
                </div>
                <div class="col-sm-7 col-sm-offset-1">
                    <input id="mainGroupId" type="text" style="display: none"/>
                    <label id="mainGroupName"></label>
                </div>
            </div>
        </div>
        <div class="form-group">
            <div class="row">
                <div class="col-sm-4">
                    <label for="addGroupInput"> Наименование </label>
                </div>
                <div class="col-sm-7 col-sm-offset-1">
                    <input id="addGroupInput" class="form-control" required="required" type="text" name="addGroupInput" />
                    <button class="btn btn-default" style="margin-top: 10px;" id="saveGroup"> Сохранить </button>
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid">
        <div class="row">
            <div class="col-sm-5">
                @(Html.Kendo().ToolBar()
                    .Name("additionToolbar")
                    .Items(items =>
                    {
                        items.Add().Type(CommandType.SplitButton).Icon("add").Text("").MenuButtons(menuButtons =>
                        {
                            menuButtons.Add().Text("Тур").Id("add-tour");
                            menuButtons.Add().Text("Группа").Id("add-group");
                            menuButtons.Add().Text("Подгруппа").Id("add-subgroup");
                        });
                    }))
            </div>
        </div>
        <div class="row">
            <div class="k-content wide flex-tree-list col-sm-5">
                <div id="treeList"></div>
            </div>
            <div class="col-sm-6">
                <div id="mainContent">

                </div>
            </div>
        </div>
    </div>
</div>


<script type="text/javascript">
    $(document).ready(function () {

        $('#additionToolbar').removeClass("k-widget");

        $("#add-tour").click(function () {
            var modal = $("#tourAdditionModal");
            ShowModal(modal);
        });
        $("#saveTour").click(function () {
            UpdateTour(true);
        });

        $("#add-group").click(function (e) {
            ShowAddGroupModal();
        });
        $("#saveGroup").click(function () {
            SaveGroup();
        });

        $("#add-subgroup").click(function (e) {
        });

        var dataSource = new kendo.data.TreeListDataSource({
			transport: {
				read: {
					url: "@Url.Action("GetGroupsForTour", "Tour", new {tourId = ViewBag.TourId})",
					dataType: "json"
				}
			},
			schema: {
				model: {
					id: "Id",
					parentId: "ParentId",
					fields: {
                        ParentId: { field: "ParentId", nullable: true },
                        Id: { field: "Id", type: "number", nullable: true },
                        TourId: { field: "TourId", type: "number", nullable: true },
                        UrlForEdit: { field: "UrlForEdit", type: "string" },
                        GroupName: { field: "GroupName", type: "string" },
                        GroupType: { field: "GroupType", type: "string" }
                    },
					expanded: true
				}
			}
		});
        $("#treeList").kendoTreeList({
            dataSource: dataSource,
            selectable: true,
            columns: [
                {
                    field: "GroupName", title: "Имя группы", headerAttributes: {
                        style: "display: none"
                    },
                    attributes: {
                        "class": "col-sm-4"
                    }
                }
            ],
            change: UpdateMainContent
        });

        $("#treeList").data("kendoTreeList").dataSource.filter({ field: "TourId", operator: "equals", value: @ViewBag.TourId });

        $('#mainContent').load('@Url.Action("TourSubCard", "Tour", new {tourId = ViewBag.TourId })');

    });

    function UpdateMainContent() {
        var row = GetSelectedRowInTree();
        if (row.length > 0) {
            var data = GetDataFromRowInTree(row);
            $('#mainContent').load(data.UrlForEdit);
        }
    }

    function GetSelectedRowInTree() {
        var treeList = $("#treeList").data("kendoTreeList");
        return treeList.select();
    }

    function GetDataFromRowInTree(row) {
        var treeList = $("#treeList").data("kendoTreeList");
        var data = treeList.dataItem(row);
        return data;
    }

    function ShowInfoWindow(message) {
        Common.UI.ShowInfo({
            content: message,
            onSuccess: function() {
                Common.UI.CloseWindow('Dashboard', window.parent);
            }
        });
    }

    function ShowModal(modal) {
        if (!modal.data("kendoWindow")) {
            modal.kendoWindow({
                visible: false,
                resizable: true,
                modal: true,
                width: '50%',
                height: '50%'
            }).data("kendoWindow").center();
        }
        modal.data("kendoWindow").open();
    }

    function UpdateTour(isAddition) {
        kendo.ui.progress($('body'), true);
        var data = !isAddition
            ? {
                id: $('input.edit-input-id-hidden').val(),
                year: $('#addTourInput').val()
            }
            : {
                id: -1,
                year: $('#addTourInput').val()
            }
        $.ajax({
            type: 'POST',
            url: '@Url.Action("TourEstimates", "Tour")',
            data: data,
            success: function (response) {
                $("#tourAdditionModal").data("kendoWindow").close();
                Common.ShowMessage(response.Success);
                window.parent.location.reload(); 
            },
            error: function (response) {
                Common.ShowError(response.responseText);
            },
            complete: function() {
                kendo.ui.progress($('body'), false);
            }
        });
    }

    function ShowAddGroupModal() {
        var row = GetSelectedRowInTree();
        if (row.length <= 0) {
            ShowInfoWindow("Для добавления группы нужно выбрать строку из дерева c основной группой");
        } else {
            var data = GetDataFromRowInTree(row);
            if (data.GroupType != "2")
                ShowInfoWindow("Нужно выбрать основную группу из дерева");
            else {
                var algorithmId = data.Id;

                //ищем корень дерева с Туром
                var treeList = $("#treeList").data("kendoTreeList");
                var rows = $("tr.k-treelist-group", treeList.tbody);
                if (rows.length > 0) {
                    var root = rows[0];
                    $("#tourYear").html(GetDataFromRowInTree(root).GroupName);
                }

                //заполняем данные для основной группы
                $("#mainGroupId").val(data.Id);
                $("#mainGroupName").html(data.GroupName);
                var modal = $("#groupAdditionModal");
                ShowModal(modal);
            }
        }
    }

    function SaveGroup() {
        kendo.ui.progress($('body'), true);
        var dto = {
            Id: null,
            RatingTourId: '@ViewBag.TourId',
            ParentGroupId: null,
            GroupingMechanismId: $('#mainGroupId').val(),
            Name: $('#addGroupInput').val()
        };

        $.ajax({
            url: '@Url.Action("EditGroup", "Tour")',
            type: 'POST',
            data: dto,
            success: function () {
                Common.ShowMessage('Сохранение выполнено');
                $("#groupAdditionModal").data("kendoWindow").close();
            },
            error: function (response) {
                Common.ShowError(response.responseText);
            },
            complete: function () {
                kendo.ui.progress($('body'), false);
            }
        });
    }

</script>

@section styles {
    <style>
        .flex-content {
            display: flex;
            height: 100%;
        }

        .flex-tree-list {
            margin: 10px;
            flex-grow: 1;
            flex-shrink: 1;
            flex-basis: auto;
            align-items: stretch;
        }

        .flex-list-buttons {
            margin: 10px;
        }

        button {
            width: 10rem;
            margin-bottom: 5px !important;
        }

        .tour p:hover {
            background: #eaeef7;
        }

        .tour p {
            padding: 5px;
        }

        #treeList {
            height: 100%;
            /*overflow: auto;*/
        }

        .selected {
            background: #eaeef7;
        }

        .control-label {
            margin-bottom: 0px;
            font-weight: normal;
            vertical-align: sub;
        }
    </style>
}