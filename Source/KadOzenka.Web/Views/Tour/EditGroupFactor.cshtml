@model KadOzenka.Web.Models.Tour.GroupFactorModel

@using (Html.BeginForm("EditGroupFactor", "Tour", FormMethod.Post))
{
    @Html.HiddenFor(m => m.Id)
    @Html.HiddenFor(m => m.GroupId)
    @Html.HiddenFor(m => m.FactorId)
    <div class="form-horizontal col-sm-12" style="margin-top: 10px">
        <div class="form-group">
            <div class="col-sm-3">
                @Html.CustomLabel("Фактор")
            </div>
            <div class="col-sm-9">
                <input name="FactorName" />
            </div>
        </div>
        <div class="form-group">
            <div class="col-sm-3">
                @Html.CustomLabel("Использовать метку")
            </div>
            <div class="col-sm-9">
                @Html.CheckBoxFor(x => x.SignMarket)
            </div>
        </div>
        <div class="form-group">
            <div class="col-sm-2 col-sm-offset-8">
                <button class="btn btn-default btn-block" type="button" id="cancel">Отмена</button>
            </div>
            <div class="col-sm-2">
                <button class="btn btn-default btn-block" type="button" id="save">Сохранить</button>
            </div>
        </div>
    </div>
}

<script src="~/js/custom-validation.js"></script>
<script>
    $(document).ready(function () {
        $('[name="FactorName"]').kendoDropDownList({
                dataTextField: 'Text',
                dataValueField: 'Value',
                filter: 'contains',
                dataSource:
                {
                    transport: {
                        read: {
                            url: '@Url.Action("GetTourFactors", "Tour")',
                            data: {
                                groupId: $('#@Html.IdFor(m => m.GroupId)').val()
                            },
                            dataType: 'json'
                        }
                    }
                },
                dataBound: function(e) {
                    if ($('#@Html.IdFor(m => m.Id)').val() != -1) {
                        $('[name="FactorName"]').data("kendoDropDownList").select(function (dataItem) {
                            return dataItem.Value == '@Model.FactorId';
                        });
                    }
                }
            });

        $('#save').on('click', function () {
            kendo.ui.progress($('body'), true);
            var form = $('form');
            var formObject = Common.Functions.FormToObject(form);
            formObject.FactorId = $('[name="FactorName"]').data("kendoDropDownList").value();

            $.post(form.attr('action'), formObject).done(function (response) {
                if (response.Errors) {
                    var errors = getErrors(response.Errors);
                    Common.ShowError(errors);
                    return;
                }

                if (response.Success && response.Id) {
                    $('#@Html.IdFor(m => m.Id)').val(response.Id);
                    Common.ShowMessage(response.Success);
                }
                Common.UI.CloseWindow('editGroupFactorWindow', window.parent, true);
            }).fail(function (response, textStatus, errorThrown) {
                Common.ShowError(response.responseText);
            }).always(function() {
                kendo.ui.progress($('body'), false);
            });
        });

        $('#cancel').on('click', function () {
            Common.UI.CloseWindow('editGroupFactorWindow', window.parent);
        });
    });
</script>
