@using KadOzenka.Web.Helpers
@using KadOzenka.Web.Models.GbuObject
@using ObjectModel.Directory
@using ObjectModel.Directory.Common
@model KadOzenka.Web.Models.GbuObject.HarmonizationViewModel

@using (Html.BeginForm("Harmonization", "GbuObject", FormMethod.Post))
{
    <div class="form-horizontal col-sm-12">
        <div class="form-group"></div>
	    @(await Html.PartialAsync("Partials/PartialCharacteristic", new PartialCharacteristicViewModel
	    {
		    IdAttributeResult = Model.IdAttributeResult,
		    IsNewAttribute = Model.IsNewAttribute,
		    NameNewAttribute = Model.NameNewAttribute,
		    RegistryId = Model.RegistryId,
		    TypeNewAttribute = Model.TypeNewAttribute
	    }))
        <div class="form-group">
            <div class="col-sm-12">
                @(Html.Kendo().RadioButtonFor(m => m.PropertyType).Label(PropertyTypes.Stead.GetEnumDescription()).Value((long)PropertyTypes.Stead))
                <span>&nbsp;</span>
                @(Html.Kendo().RadioButtonFor(m => m.PropertyType).Label(PropertyTypes.Building.GetEnumDescription()).Value((long)PropertyTypes.Building))
                <span>&nbsp;</span>
                @(Html.Kendo().RadioButtonFor(m => m.PropertyType).Label(PropertyTypes.Construction.GetEnumDescription()).Value((long)PropertyTypes.Construction))
                <span>&nbsp;</span>
                @(Html.Kendo().RadioButtonFor(m => m.PropertyType).Label("ОНС").Value((long)PropertyTypes.UncompletedBuilding))
                <span>&nbsp;</span>
                @(Html.Kendo().RadioButtonFor(m => m.PropertyType).Label(PropertyTypes.Pllacement.GetEnumDescription()).Value((long)PropertyTypes.Pllacement))
            </div>
            
        </div>
        <fieldset class="filterFieldset">
            <div class="form-group">
                <div class="col-sm-12">
                    @Html.Kendo().RadioButtonFor(m => m.SelectAllObject).Label("Все объекты").Value(true)
                </div>
            </div>
            <div class="form-group">
                <div class="col-sm-12">
                    @Html.Kendo().RadioButtonFor(m => m.SelectAllObject).Label("По значению").Value(false)
                </div>
            </div>
            <div class="form-group">
                <div class="col-sm-7">
                    <div class="col-sm-3">
                        @Html.CustomLabelFor(m => m.IdAttributeFilter)
                    </div>
                    <div class="col-sm-9">
                        @Html.KendoDropDownListTreeWithButton(m => m.IdAttributeFilter, (IEnumerable<DropDownTreeItemModel>)ViewData["TreeAttributes"], isReadonly: Model.SelectAllObject)
                    </div>
                </div>
                <div class="col-sm-5">
                    <div class="col-sm-3">
                        @Html.CustomLabelFor(m => m.ValuesFilter)
                    </div>
                    <div class="col-sm-9">
                        <select id="valuesFilter" style="width: 100%;"></select>
                    </div>
                </div>
            </div>
        </fieldset>
        <fieldset class="filterFieldset">
            <div class="form-group">
                <div class="col-sm-2">
                    @Html.Kendo().RadioButtonFor(m => m.IsDataActualUsed).Label("Дата актуализации").Value(true).Enable(!Model.SelectAllObject)
                </div>
                <div class="col-sm-4">
                    @(Html.Kendo().DatePickerFor(m => m.DataActual).Enable(Model.IsDataActualUsed.HasValue && Model.IsDataActualUsed.Value))
                </div>
            </div>
            <div class="form-group">
                <div class="col-sm-2">
                    @Html.Kendo().RadioButtonFor(m => m.IsDataActualUsed).Label("Задания на оценку").Value(false).Enable(!Model.SelectAllObject)
                </div>
                <div class="col-sm-10">
                    @(Html.Kendo().MultiSelectFor(m => m.TaskFilter)
                    .DataTextField("Text")
                    .DataValueField("Value")
                    .Filter("contains")
                    .DataSource(source =>
                    {
                        source.Read(read =>
                        {
                            read.Action("GetTasksData", "GbuObject");
                        })
                        .ServerFiltering(false);
                    }).Enable(Model.IsDataActualUsed.HasValue && !Model.IsDataActualUsed.Value))
                </div>
            </div>
        </fieldset>
        <fieldset class="attrLevelFieldset">
            <legend>1 уровень</legend>
            <div class="col-sm-2">
                @Html.CustomLabel("Характеристика")
            </div>
            <div class="col-sm-10">
                @Html.KendoDropDownListTreeWithButton(m => m.Level1Attribute, (IEnumerable<DropDownTreeItemModel>)ViewData["TreeAttributes"])
            </div>
        </fieldset>
        <fieldset class="attrLevelFieldset">
            <legend>2 уровень</legend>
            <div class="col-sm-2">
                @Html.CustomLabel("Характеристика")
            </div>
            <div class="col-sm-10">
                @Html.KendoDropDownListTreeWithButton(m => m.Level2Attribute, (IEnumerable<DropDownTreeItemModel>)ViewData["TreeAttributes"])
            </div>
        </fieldset>
        <fieldset class="attrLevelFieldset">
            <legend>3 уровень</legend>
            <div class="col-sm-2">
                @Html.CustomLabel("Характеристика")
            </div>
            <div class="col-sm-10">
                @Html.KendoDropDownListTreeWithButton(m => m.Level3Attribute, (IEnumerable<DropDownTreeItemModel>)ViewData["TreeAttributes"])
            </div>
        </fieldset>
        <fieldset class="attrLevelFieldset">
            <legend>4 уровень</legend>
            <div class="col-sm-2">
                @Html.CustomLabel("Характеристика")
            </div>
            <div class="col-sm-10">
                @Html.KendoDropDownListTreeWithButton(m => m.Level4Attribute, (IEnumerable<DropDownTreeItemModel>)ViewData["TreeAttributes"])
            </div>
        </fieldset>
        <fieldset class="attrLevelFieldset">
            <legend>5 уровень</legend>
            <div class="col-sm-2">
                @Html.CustomLabel("Характеристика")
            </div>
            <div class="col-sm-10">
                @Html.KendoDropDownListTreeWithButton(m => m.Level5Attribute, (IEnumerable<DropDownTreeItemModel>)ViewData["TreeAttributes"])
            </div>
        </fieldset>
        <fieldset class="attrLevelFieldset">
            <legend>6 уровень</legend>
            <div class="col-sm-2">
                @Html.CustomLabel("Характеристика")
            </div>
            <div class="col-sm-10">
                @Html.KendoDropDownListTreeWithButton(m => m.Level6Attribute, (IEnumerable<DropDownTreeItemModel>)ViewData["TreeAttributes"])
            </div>
        </fieldset>
        <fieldset class="attrLevelFieldset">
            <legend>7 уровень</legend>
            <div class="col-sm-2">
                @Html.CustomLabel("Характеристика")
            </div>
            <div class="col-sm-10">
                @Html.KendoDropDownListTreeWithButton(m => m.Level7Attribute, (IEnumerable<DropDownTreeItemModel>)ViewData["TreeAttributes"])
            </div>
        </fieldset>
        <fieldset class="attrLevelFieldset">
            <legend>8 уровень</legend>
            <div class="col-sm-2">
                @Html.CustomLabel("Характеристика")
            </div>
            <div class="col-sm-10">
                @Html.KendoDropDownListTreeWithButton(m => m.Level8Attribute, (IEnumerable<DropDownTreeItemModel>)ViewData["TreeAttributes"])
            </div>
        </fieldset>
        <fieldset class="attrLevelFieldset">
            <legend>9 уровень</legend>
            <div class="col-sm-2">
                @Html.CustomLabel("Характеристика")
            </div>
            <div class="col-sm-10">
                @Html.KendoDropDownListTreeWithButton(m => m.Level9Attribute, (IEnumerable<DropDownTreeItemModel>)ViewData["TreeAttributes"])
            </div>
        </fieldset>
        <fieldset class="attrLevelFieldset">
            <legend>10 уровень</legend>
            <div class="col-sm-2">
                @Html.CustomLabel("Характеристика")
            </div>
            <div class="col-sm-10">
                @Html.KendoDropDownListTreeWithButton(m => m.Level10Attribute, (IEnumerable<DropDownTreeItemModel>)ViewData["TreeAttributes"])
            </div>
        </fieldset>
	    <div class="form-group">
		    <div class="col-sm-7">
			    @( await Html.PartialAsync("/Views/Shared/PartialTemplateStorage.cshtml", new TemplateStorageViewModel
			{
				ControllerName = "GbuObject",
				ActionName = "GetTemplatesHarmonization"
			}))
		    </div>
		    <div class="col-sm-2 col-sm-offset-3">
			    <button style="float: right" id="performHarmonization" class="k-button" type="button">Выполнить</button>
		    </div>
	    </div>
    </div>
}

@section styles {
    <style>
        fieldset.attrLevelFieldset {
            border: 1px solid #c8c6cc;
            border-radius: 6px;
            margin-bottom: 10px;
            padding-bottom: 10px;
        }

            fieldset.attrLevelFieldset legend {
                font-size: initial;
                font-style: italic;
                margin: 0;
            }

        fieldset.filterFieldset {
            border: 1px solid #656565;
            margin-bottom: 10px;
            padding-bottom: 10px;
            padding-top: 10px;
        }

        #valuesFilter-list {
            display: none !important;
        }

        .filter {
            padding-top: 5px;
        }
    </style>
}
@section scripts {
	<script type="text/javascript">

        var dataActualRadioButtonPrevValue, taskRadioButtonPrevValue;

        function fillForm(data) {
        $('#valuesFilter').getKendoMultiSelect().value([]);
        $('#@(nameof(Model.TaskFilter))').data("kendoMultiSelect").value([]);
		data.forEach(function (val) {
			if (Object.keys(val)[0].includes('Level') || Object.keys(val)[0].includes('IdAttributeResult') ||
				 Object.keys(val)[0].includes('IdAttributeFilter')) {
				$('#' + Object.keys(val)[0]).data('kendoDropDownTree').value(val[Object.keys(val)[0]]);
			}

			if (Object.keys(val)[0].includes('ValuesFilter')) {
				var widget = $('#valuesFilter').getKendoMultiSelect();
				var dataSource = widget.dataSource;
				var newItem = {
					valuesFilter: val[Object.keys(val)[0]],
					valuesFilterName: val[Object.keys(val)[0]]
				};

				dataSource.add(newItem);
				var newValue = newItem.valuesFilter;
				widget.value(widget.value().concat([newValue]));
			}

			if (Object.keys(val)[0] === '@(nameof(Model.SelectAllObject))') {
				if (!!val[Object.keys(val)[0]]) {
                    $('#@(nameof(Model.SelectAllObject))_True').prop("checked", true);
				    changeAttributeFilterAvailability(true);
					return;
				}
                $('#@(nameof(Model.SelectAllObject))_False').prop("checked", true);
			    changeAttributeFilterAvailability(false);
            }

            if (Object.keys(val)[0] === '@(nameof(Model.IsDataActualUsed))') {
		        if (!!val[Object.keys(val)[0]]) {
                    $('#@(nameof(Model.IsDataActualUsed))_True').prop("checked", true);
		            $('input[type="radio"][name="IsDataActualUsed"][value="True"] ').trigger("change");
		            return;
		        }
                $('#@(nameof(Model.IsDataActualUsed))_False').prop("checked", true);
                $('input[type="radio"][name="IsDataActualUsed"][value="False"] ').trigger("change");
            }

            if (Object.keys(val)[0] === '@(nameof(Model.DataActual))') {
                $('#@(nameof(Model.DataActual))').data('kendoDatePicker').value(kendo.parseDate(val[Object.keys(val)[0]]));
            }

            if (Object.keys(val)[0].includes('@(nameof(Model.TaskFilter))')) {
                var currentValue = $('#@(nameof(Model.TaskFilter))').data("kendoMultiSelect").value();
                currentValue.push([val[Object.keys(val)[0]]]);
                $('#@(nameof(Model.TaskFilter))').data("kendoMultiSelect").value(currentValue);
		    }

			if (Object.keys(val)[0] === 'PropertyType') {
				var id = '#PropertyType_' + val[Object.keys(val)[0]];
				$(id).prop("checked", true);
			}

		});
        var isSelectAllObjectsChecked =
                $('input[type="radio"][name="SelectAllObject"][value="True"] ').prop('checked');
        changeDataActualBlockAvailability(isSelectAllObjectsChecked);
    }

		$(document).ready(function () {

            templateStorage.init(@((int)DataFormStorege.Harmonization), "SaveTemplateHarmonizationObject", "GbuObject", "GetTemplatesOneGroup", "GbuObject", fillForm);
		    initIsDataActualUsedClickHandler();
		    initIsDataActualUsedChangedHandler();
            initSelectAllObjectChangedHandler();

			function onDataBound(e) {
				$('.k-multiselect .k-input').unbind('keyup');
				$('.k-multiselect .k-input').on('keyup', onClickEnter);
			}
			function onClickEnter(e) {
				if (e.keyCode === 13) {
					var widget = $('#valuesFilter').getKendoMultiSelect();
					var dataSource = widget.dataSource;
					var input = $('.k-multiselect .k-input');
					var value = input.val().trim();
					if (!value || value.length === 0) {
						return;
					}
					var newItem = {
						valuesFilter: value,
						valuesFilterName: value
					};

					dataSource.add(newItem);
					var newValue = newItem.valuesFilter;
					widget.value(widget.value().concat([newValue]));
				}
			}
			$("#valuesFilter").kendoMultiSelect({
				dataTextField: "valuesFilterName",
				dataValueField: "valuesFilter",
				dataSource: {
					data: []
				},
                dataBound: onDataBound,
                enable: @(Model.SelectAllObject ? "false" : "true")
			});

			$('#performHarmonization').on('click',
				function() {
					kendo.ui.progress($('body'), true);
					var form = $('form');
					var formObject = Common.Functions.FormToObject(form);
                    formObject.ValuesFilter = $("#valuesFilter").data("kendoMultiSelect").value();
                    formObject.TaskFilter = $('#@(nameof(Model.TaskFilter))').data("kendoMultiSelect").value();
					$.post(form.attr('action'), formObject).done(function(response) {
						kendo.ui.progress($('body'), false);
						if (response.Errors) {
							var errors = $.map(distinctErrors(response.Errors),
								function(el) {
									return el.Message;
								});
							Common.ShowError(errors);
							return;
						}
						if (response.Success) {
							if (response.idResultAttribute && updateResultControl) {
								updateResultControl(response.idResultAttribute);
							}
							Common.ShowMessage(response.Success);
						}
					}).fail(function (response, textStatus, errorThrown) {
						kendo.ui.progress($('body'), false);
						Common.ShowError(response.responseText);
					});
				});
		});

        function distinctErrors(errors) {
            var result = [];
            $.each(errors,
                function (index, event) {
                    var events = $.grep(result,
                        function (e) {
                            return event.Message === e.Message;
                        });
                    if (events.length === 0) {
                        result.push(event);
                    }
                });

            return result;
        }

        function initSelectAllObjectChangedHandler() {
            $('input[type="radio"][name="SelectAllObject"][value="True"] ').change(function() {
                if (this.checked) {
                    changeAttributeFilterAvailability(true);
                }
            });
            $('input[type="radio"][name="SelectAllObject"][value="False"] ').change(function() {
                if (this.checked) {
                    changeAttributeFilterAvailability(false);
                }
            });
        }

        function initIsDataActualUsedClickHandler() {
            $('input[type="radio"][name="IsDataActualUsed"][value="True"] ').click(function () {
                if (dataActualRadioButtonPrevValue && this.checked) {
                    $('input[type="radio"][name="IsDataActualUsed"][value="True"] ').prop('checked', false);
                    $('input[type="radio"][name="IsDataActualUsed"][value="True"] ').trigger("change");
                }
            });
            $('input[type="radio"][name="IsDataActualUsed"][value="False"] ').click(function () {
                if (taskRadioButtonPrevValue && this.checked) {
                    $('input[type="radio"][name="IsDataActualUsed"][value="False"] ').prop('checked', false);
                    $('input[type="radio"][name="IsDataActualUsed"][value="False"] ').trigger("change");
                }
            });
        }

        function initIsDataActualUsedChangedHandler() {
            $('input[type="radio"][name="IsDataActualUsed"][value="True"] ').change(function() {
                if (this.checked) {
                    changeDataActualAvailability(true, false);
                    dataActualRadioButtonPrevValue = true;
                } else {
                    changeDataActualAvailability(false, false);
                    dataActualRadioButtonPrevValue = false;
                }
                taskRadioButtonPrevValue = false;
            });
            $('input[type="radio"][name="IsDataActualUsed"][value="False"] ').change(function() {
                if (this.checked) {
                    changeDataActualAvailability(false, true);
                    taskRadioButtonPrevValue = true;
                } else {
                    changeDataActualAvailability(false, false);
                    taskRadioButtonPrevValue = false;
                }
                dataActualRadioButtonPrevValue = false;
            });
        }

        function changeDataActualAvailability(isDataActualUsed, isTaskUsed) {
            if (isDataActualUsed) {
                $('#@(nameof(Model.TaskFilter))').data("kendoMultiSelect").value([]);
                $('#@(nameof(Model.TaskFilter))').data("kendoMultiSelect").enable(false);
                $('#@(nameof(Model.DataActual))').data('kendoDatePicker').enable(true);
            } else if (isTaskUsed) {
                $('#@(nameof(Model.DataActual))').data('kendoDatePicker').value(null);
                $('#@(nameof(Model.DataActual))').data('kendoDatePicker').enable(false);
                $('#@(nameof(Model.TaskFilter))').data("kendoMultiSelect").enable(true);
            } else {
                $('#@(nameof(Model.TaskFilter))').data("kendoMultiSelect").value([]);
                $('#@(nameof(Model.DataActual))').data('kendoDatePicker').value(null);
                $('#@(nameof(Model.TaskFilter))').data("kendoMultiSelect").enable(false);
                $('#@(nameof(Model.DataActual))').data('kendoDatePicker').enable(false);
            }
		}

        function changeDataActualBlockAvailability(disable) {
            if (disable) {
                changeDataActualAvailability(false, false);
                $('input[type="radio"][name="IsDataActualUsed"][value="True"] ').prop('checked', false);
                $('input[type="radio"][name="IsDataActualUsed"][value="False"] ').prop('checked', false);
                $('input[type="radio"][name="IsDataActualUsed"][value="True"] ').attr('disabled', true);
                $('input[type="radio"][name="IsDataActualUsed"][value="False"] ').attr('disabled', true);
                taskRadioButtonPrevValue = false;
                dataActualRadioButtonPrevValue = false;
            } else {
                $('input[type="radio"][name="IsDataActualUsed"][value="True"] ').attr('disabled', false);
                $('input[type="radio"][name="IsDataActualUsed"][value="False"] ').attr('disabled', false);
            }
        }

        function changeAttributeFilterAvailability(areFieldsReadonly) {
            if (areFieldsReadonly) {
                $('#@(nameof(Model.IdAttributeFilter))').data('kendoDropDownTree').value('');
				$('#@(nameof(Model.IdAttributeFilter))').data('kendoDropDownTree').enable(false);
                $('a.clear-button-@(nameof(Model.IdAttributeFilter))').addClass('k-state-disabled');

                $('#valuesFilter').data("kendoMultiSelect").value([]);
                $('#valuesFilter').data("kendoMultiSelect").enable(false);
            } else {
				$('#@(nameof(Model.IdAttributeFilter))').data('kendoDropDownTree').enable(true);
                $('a.clear-button-@(nameof(Model.IdAttributeFilter))').removeClass('k-state-disabled');
                $('#valuesFilter').data("kendoMultiSelect").enable(true);
            }
            changeDataActualBlockAvailability(areFieldsReadonly);
        }
    </script>
}