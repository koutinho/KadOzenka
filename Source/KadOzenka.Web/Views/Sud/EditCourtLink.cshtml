@using CIPJS.Helpers
@using ObjectModel.Sud

@model KadOzenka.Web.Models.Sud.CourtLinkModel

@using (Html.BeginForm("EditCourtLink", "Sud", FormMethod.Post))
{
	@Html.HiddenFor(m => m.Id)
	@Html.HiddenFor(m => m.SudId)
	@Html.HiddenFor(m => m.ObjectId)
	<div class="form-horizontal col-sm-12">
		<div class="form-group"></div>
		<div class="form-group">
			<div class="col-sm-2">
				@Html.CustomLabelFor("Судебное решение", true)
			</div>
			<div class="col-sm-10">
				@Html.AutoCompleteWithEditButton(m => m.SudNumber, "Value", "Sud", "GetAutoCompleteCourt", "clearEvent", "editCourt", "selectEvent", isReadonly: false)
			</div>
		</div>
		<div class="form-group">
			<div class="col-sm-2">
				@Html.CustomLabelFor(m => m.Rs)
			</div>
			<div class="col-sm-4">
				@Html.KendoNumericTextBoxFor(m => m.Rs, 2, isReadonly: false)
			</div>
		</div>
		<div class="form-group">
			<div class="col-sm-2">
				@Html.CustomLabelFor(m => m.Use)
			</div>
			<div class="col-sm-10">
				@Html.TextAreaFor(m => m.Use, 5, 0, new {@class = "k-textbox", @style = "width: 100%; resize: none; padding: 10px;"})
			</div>
		</div>
		<div class="form-group">
			<div class="col-sm-2">
				@Html.CustomLabelFor(m => m.Description)
			</div>
			<div class="col-sm-10">
				@Html.TextAreaFor(m => m.Description, 5, 0, new {@class = "k-textbox", @style = "width: 100%; resize: none; padding: 10px;"})
			</div>
		</div>
		<div class="form-group">
			<div class="col-sm-12">
				<button style="float: right" id="save" type="button">Сохранить</button>
			</div>
		</div>
	</div>
}

<script type="text/javascript">
	function selectEvent() {
		$('#@Html.IdFor(m => m.SudId)').val(this.e.dataItem.Id);
	}

	function clearEvent() {
		$('#@Html.IdFor(m => m.SudId)').val(0);
	}

	function editCourt() {
		var contentUrl = '@Url.Action("SudReshSelect", "RegistersView")';
		var title = 'Выбор судебных решений';

		var callbackFn = function (item) {
			kendo.ui.progress($('body'), true);
			$('[name="SudId"]').val(item.ID);
			$.ajax({
				type: 'GET',
				url: '@Url.Action("GetCourtData", "Sud")',
				data: { 'sudId': item.ID },
				dataType: 'json',
				success: function (response) {
					if (response && !$.isEmptyObject(response)) {
						console.log('response', response);
						$('#@Html.IdFor(m => m.SudNumber)').val(response.data.Value);
					}
					kendo.ui.progress($('body'), false);
				}
			});
		}
		Common.UI.ChooseWindow(title, contentUrl, callbackFn, 'Grid-@OMSud.GetRegisterId()');
	}

	$(document).ready(function () {

		$('#@Html.IdFor(m => m.SudNumber)').on('blur', function () {
			if ($('#@Html.IdFor(m => m.SudNumber)').val() === "") {
				$('#@Html.IdFor(m => m.SudId)').val(0);
				return;
			}

			if ($('#@Html.IdFor(m => m.SudId)').val() === "0" || $('#@Html.IdFor(m => m.SudId)').val() === "") {
				$('#@Html.IdFor(m => m.SudNumber)').val("");
			}
		});


		$('#save').on('click',
			function() {
				var form = $('form');
				var formObject = Common.Functions.FormToObject(form);
				kendo.ui.progress($('body'), true);

				$.post(form.attr('action'), formObject).done(function(response) {
					kendo.ui.progress($('body'), false);
					if (response.Errors) {
						var errors = $.map(distinctErrors(response.Errors),
							function(el) {
								return el.Message;
							});
						Common.ShowError(errors);
						return;
					}
					if (response.Success && response.data) {
						$('#@Html.IdFor(m => m.Id)').val(response.data.Id);
						Common.ShowMessage(response.Success);
					}
				});
			});
	});

	function distinctErrors(errors) {
		var result = [];
		$.each(errors, function(index, event) {
			var events = $.grep(result, function (e) {
				return event.Message === e.Message;
			});
			if (events.length === 0) {
				result.push(event);
			}
		});

		return result;
	}
</script>