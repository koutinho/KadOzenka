@using KadOzenka.Web.Helpers
@using KadOzenka.Web.Models.GbuObject
@using KadOzenka.Web.Models.Task
@using ObjectModel.Directory
@using KadOzenka.Dal.DataImport.DataImporterGknNew.Attributes
@using KadOzenka.Web.Models.DataImportByTemplate
@model KadOzenka.Web.Models.YrlParser.YrlFeedParserTaskViewModel

<div id="toolbar"></div>
<div>
    <ul id="ls_panelbar" class="panelbar">
        <li id="XmlFiles" data-expand>
            <span id="filesBlockLabel">XML-файлы</span>
            <div>
                <form id="xmlFileForm" class="form-horizontal col-sm-12">
                    <div id="xmlFilesWrapper">
                        <input name="xmlFiles" id="xmlFiles" type="file" aria-label="files" accept=".xml, .xlsx, .zip, .rar"/>
                    </div>
                </form>
            </div>
        </li>
    </ul>
</div>


@section styles {
    <link rel="stylesheet" href="~/css/jquery.fancybox.min.css" />
    <link rel="stylesheet" href="~/css/data-import-by-template.css" />
    <style>
        #ls_panelbar {
            width: 95%;
        }
        #filter {
            width: 100%;
        }
    </style>
}



<script src="~/js/custom-validation.js"></script>
<script src="~/js/jquery.fancybox.min.js"></script>
<script src="~/js/data-import-by-template.js"></script>
<script type="text/x-kendo-tmpl" id="template">
        <div class="matchItem k-widget">
            <span>
                    <span>#:ColumnName#</span>
                    <span>-</span>
                    <span>#:AttributeDescription#</span>
                    <span #=IsReadOnly ? 'style="display: none"' : '' #>
                        <a class="k-button k-delete-button deleteButton" href="\\#">
                            <span class="k-icon k-i-close"></span>
                        </a>
                </span>
            </span>
        </div>
</script>


<script type="module" src="~/js/chunk-uploader/chunk-uploader-widget.js"></script>
<script>
    var dataSource = new kendo.data.DataSource({
        data: [ ]
    });

    function fileCheck(fileArray){
        let tmpMessage = [];
        let fileReader = new FileReader();
        fileArray.forEach( function (file) {
            fileReader.readAsArrayBuffer(file.slice(0,1));
            if (fileReader.result == null){
                tmpMessage+= "Файл не найден или изменён: " + file.name + "<br>";
            }
        });
        return tmpMessage;
    }

    $(document).ready(function() {
        var panelbar = $('#ls_panelbar').kendoPanelBar().data('kendoPanelBar');
        panelbar.expand('li[data-expand]');

        var generalAllowedFilesExtensions = ['.xml'];

        var toolbar = $("#toolbar").kendoToolBar({
            items: [
                {
                    type: 'button',
                    id: 'check',
                    text: 'Сохранить',
                    icon: 'save',
                    click: function() {
                        var message = [];
                        var xmlUploader = $('#xmlFilesWrapper').data('ko-chunkUpload');
                        var xmlFiles = xmlUploader.getFiles();
                        checkError(xmlFiles);
                        if (message.length !== 0) {
                            Common.ShowError(message);
                            return;
                        }
                        kendo.ui.progress($('body'), true);
                        if (xmlFiles.length > 0) {
                            xmlUploader.upload()
                                .then((uuid) => save(uuid))
                                .catch(error => console.error(error));
                        } else {
                            save();
                        }
                        return;

                        function checkError(files) {
                            $.each(files,
                                (function(index, value) {
                                    if ($.inArray(value.extension, generalAllowedFilesExtensions) === -1)
                                        message += 'Загружены файлы недопустимого формата (разрешенные форматы: .xml, .zip, .rar)<br>';
                                }));
                        }

                        function save(uuid = null) {
                            try {
                            var formData = new FormData();
                            formData.set('uuid', uuid);
                            $.ajax({
                                type: 'POST',
                                url: '@Url.Action("YrlParserCreateImportTask", "YrlParser")',
                                data: formData,
                                processData: false,
                                contentType: false,
                                success: function(e) {
                                    if (e.Errors) {
                                        var errors = getErrors(e.Errors);
                                        Common.ShowError(errors);
                                        return;
                                    } else {
                                        Common.ShowMessage(e.Msg);
                                        setTimeout(function() {
                                                Common.UI.CloseWindow('MainMenuWindow', window.parent);
                                            },
                                            1000);
                                    }
                                },
                                error: function(e) {
                                    var msg = e.responseText ? e.responseText : 'Ошибка загрузки. Обратитесь к администратору.';
                                    xmlUploader.deleteFilesByUid(uuid);
                                    Common.ShowError(msg);
                                },
                                complete: function() {
                                    kendo.ui.progress($('body'), false);
                                   
                                }
                            });
                            } catch (e) {
                                console.error(e);
                                kendo.ui.progress($('body'), false);
                            }
                        }
                    }
                }
            ]
        });


        $('#xmlFilesWrapper').chunkUpload({
            chunkSize: 10_000_000
        });
    });

</script>