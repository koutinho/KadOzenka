@using System.Collections
@using KadOzenka.Web.Helpers
@model KadOzenka.Web.Models.Task.ExportAttributesModel

@using (Html.BeginForm("TransferAttributes", "Task", FormMethod.Post))
{
    <div class="form-horizontal col-sm-12" style="margin-top: 10px">

        <div class="form-group">
            <div class="col-sm-2">
                @Html.CustomLabel("Тур оценки")
            </div>
            <div class="col-sm-4">
                @(Html.Kendo().DropDownList()
                              .Name("RatingTour")
                              .DataTextField("Text")
                              .DataValueField("Value")
                )
            </div>
        </div>

        <div class="form-group">
            <div class="col-sm-2">
                @Html.CustomLabel("Задание на оценку")
            </div>
            <div class="col-sm-10">
                @(Html.Kendo().DropDownList()
                              .Name("task")
                              .DataTextField("Text")
                              .DataValueField("Value")
                )
            </div>
        </div>

        <div class="form-group">
            <div class="col-sm-9 col-sm-offset-2">
                <div class="radio-inline">
                    <label for="Parcel" style="font-weight: normal">Земельный участок</label>
                    <input type="radio" id="Parcel" name="ObjType" class="custom-control-input" checked>
                </div>
                <div class="radio-inline">
                    <label for="OKS" style="font-weight: normal">Объект капитального строительства</label>
                    <input type="radio" id="OKS" name="ObjType" class="custom-control-input">
                </div>
            </div>
        </div>

        <div id="attributesList">
            <div class="form-group attributes-list">
                <div class="col-sm-5 col-sm-offset-2">
                    <div>
                        @Html.KendoDropDownListWithAutocompleteFor(m => m.IdAttributeKO1, (IEnumerable)ViewData["KoAttributes"], dataValueField: "Id")
                    </div>
                </div>
                <div class="col-sm-5">
                    <div>
                        @Html.KendoDropDownListWithAutocompleteFor(m => m.IdAttributeGBU1, (IEnumerable)ViewData["GbuAttributes"], dataValueField: "Id")
                    </div>
                </div>
            </div>
            <div class="form-group attributes-list">
                <div class="col-sm-5 col-sm-offset-2">
                    <div>
                        @Html.KendoDropDownListWithAutocompleteFor(m => m.IdAttributeKO2, (IEnumerable)ViewData["KoAttributes"], dataValueField: "Id")
                    </div>
                </div>
                <div class="col-sm-5">
                    <div>
                        @Html.KendoDropDownListWithAutocompleteFor(m => m.IdAttributeGBU2, (IEnumerable)ViewData["GbuAttributes"], dataValueField: "Id")
                    </div>
                </div>
            </div>
            <div class="form-group attributes-list">
                <div class="col-sm-5 col-sm-offset-2">
                    <div>
                        @Html.KendoDropDownListWithAutocompleteFor(m => m.IdAttributeKO3, (IEnumerable)ViewData["KoAttributes"], dataValueField: "Id")
                    </div>
                </div>
                <div class="col-sm-5">
                    <div>
                        @Html.KendoDropDownListWithAutocompleteFor(m => m.IdAttributeGBU3, (IEnumerable)ViewData["GbuAttributes"], dataValueField: "Id")
                    </div>
                </div>
            </div>
            <div class="form-group attributes-list">
                <div class="col-sm-5 col-sm-offset-2">
                    <div>
                        @Html.KendoDropDownListWithAutocompleteFor(m => m.IdAttributeKO4, (IEnumerable)ViewData["KoAttributes"], dataValueField: "Id")
                    </div>
                </div>
                <div class="col-sm-5">
                    <div>
                        @Html.KendoDropDownListWithAutocompleteFor(m => m.IdAttributeGBU4, (IEnumerable)ViewData["GbuAttributes"], dataValueField: "Id")
                    </div>
                </div>
            </div>
            <div class="form-group attributes-list">
                <div class="col-sm-5 col-sm-offset-2">
                    <div>
                        @Html.KendoDropDownListWithAutocompleteFor(m => m.IdAttributeKO5, (IEnumerable)ViewData["KoAttributes"], dataValueField: "Id")
                    </div>
                </div>
                <div class="col-sm-5">
                    <div>
                        @Html.KendoDropDownListWithAutocompleteFor(m => m.IdAttributeGBU5, (IEnumerable)ViewData["GbuAttributes"], dataValueField: "Id")
                    </div>
                </div>
            </div>
            <div class="form-group attributes-list">
                <div class="col-sm-5 col-sm-offset-2">
                    <div>
                        @Html.KendoDropDownListWithAutocompleteFor(m => m.IdAttributeKO6, (IEnumerable)ViewData["KoAttributes"], dataValueField: "Id")
                    </div>
                </div>
                <div class="col-sm-5">
                    <div>
                        @Html.KendoDropDownListWithAutocompleteFor(m => m.IdAttributeGBU6, (IEnumerable)ViewData["GbuAttributes"], dataValueField: "Id")
                    </div>
                </div>
            </div>
            <div class="form-group attributes-list">
                <div class="col-sm-5 col-sm-offset-2">
                    <div>
                        @Html.KendoDropDownListWithAutocompleteFor(m => m.IdAttributeKO7, (IEnumerable)ViewData["KoAttributes"], dataValueField: "Id")
                    </div>
                </div>
                <div class="col-sm-5">
                    <div>
                        @Html.KendoDropDownListWithAutocompleteFor(m => m.IdAttributeGBU7, (IEnumerable)ViewData["GbuAttributes"], dataValueField: "Id")
                    </div>
                </div>
            </div>
            <div class="form-group attributes-list">
                <div class="col-sm-5 col-sm-offset-2">
                    <div>
                        @Html.KendoDropDownListWithAutocompleteFor(m => m.IdAttributeKO8, (IEnumerable)ViewData["KoAttributes"], dataValueField: "Id")
                    </div>
                </div>
                <div class="col-sm-5">
                    <div>
                        @Html.KendoDropDownListWithAutocompleteFor(m => m.IdAttributeGBU8, (IEnumerable)ViewData["GbuAttributes"], dataValueField: "Id")
                    </div>
                </div>
            </div>
            <div class="form-group attributes-list">
                <div class="col-sm-5 col-sm-offset-2">
                    <div>
                        @Html.KendoDropDownListWithAutocompleteFor(m => m.IdAttributeKO9, (IEnumerable)ViewData["KoAttributes"], dataValueField: "Id")
                    </div>
                </div>
                <div class="col-sm-5">
                    <div>
                        @Html.KendoDropDownListWithAutocompleteFor(m => m.IdAttributeGBU9, (IEnumerable)ViewData["GbuAttributes"], dataValueField: "Id")
                    </div>
                </div>
            </div>
            <div class="form-group attributes-list">
                <div class="col-sm-5 col-sm-offset-2">
                    <div>
                        @Html.KendoDropDownListWithAutocompleteFor(m => m.IdAttributeKO10, (IEnumerable)ViewData["KoAttributes"], dataValueField: "Id")
                    </div>
                </div>
                <div class="col-sm-5">
                    <div>
                        @Html.KendoDropDownListWithAutocompleteFor(m => m.IdAttributeGBU10, (IEnumerable)ViewData["GbuAttributes"], dataValueField: "Id")
                    </div>
                </div>
            </div>
        </div>

        <div class="form-group">
            <div class="col-sm-2 col-sm-offset-10">
                @(Html.Kendo().Button()
                            .Name("execute")
                            .Content("Выполнить")
                )
            </div>
        </div>
    </div>
}



<style>
    .attributes-list {
        padding-right: 2%;
    }
     
</style>

<script>
    $(document).ready(function() {

        $('[name="RatingTour"]')
            .kendoDropDownList({
                dataTextField: 'Text',
                dataValueField: 'Value',
                dataSource:
                {
                    transport: {
                        read: {
                            url: '@Url.Action("GetRatingTours", "Tour")',
                            dataType: 'json'
                        }
                    }
                }
            });

        $('[name="RatingTour"]').data('kendoDropDownList').bind('dataBound', initTasksList);
        $('[name="RatingTour"]').data('kendoDropDownList').bind('dataBound', initKoAttributes);
        $('[name="RatingTour"]').data('kendoDropDownList').bind('change', initTasksList);
        $('[name="RatingTour"]').data('kendoDropDownList').bind('change', initKoAttributes);
        $('[name="ObjType"]').on('change', initKoAttributes);

        $('#execute').on('click', transferAttributes);
    });




    function initTasksList() {
        var tourId = $('#RatingTour').val();
        kendo.ui.progress($('body'), true);
        $('[name="task"]')
            .kendoDropDownList({
                dataTextField: 'Text',
                dataValueField: 'Value',
                optionLabel: "--Выберите задание--",
                dataSource:
                {
                    transport: {
                        read: {
                            url: '@Url.Action("GetTasksByTour", "Task")',
                            data: { tourId: tourId },
                            dataType: 'json'
                        }
                    }
                },
                dataBound: function() {
                    kendo.ui.progress($('body'), false);
                    this.select(1);
                }
            });
    }


    function initKoAttributes() {
        var tourId = $('#RatingTour').val();
        var objectType = $('input[name="ObjType"]:checked')[0].id;

        var koAttributesSource = new kendo.data.DataSource({
            transport: {
                read: {
                    url: '@Url.Action("GetKoAttributes", "Task")',
                    data: { tourId: tourId, objectType: objectType },
                    dataType: 'json'
                }
            }
        });
        $('[name^="IdAttributeKO"]').each(function() {
            $(this).kendoDropDownList({
                dataTextField: 'Text',
                dataValueField: 'Value',
                optionLabel: " ",
                dataSource: koAttributesSource
            });
        });
    }


    function transferAttributes() {
        var form = $('form');
        var formObject = Common.Functions.FormToObject(form);
        formObject['TaskId'] = $("#task").data('kendoDropDownList').value();
        formObject['ObjType'] = $('input[name="ObjType"]:checked')[0].id;

        kendo.ui.progress($('body'), true);
        $.ajax({
            type: 'POST',
            url: form.attr('action'),
            data: formObject,
            success: function() {
                Common.ShowMessage('Операция успешно выполнена');
            },
            error: function(response) {
                Common.ShowError(response.responseText);
            },
            complete: function() {
                kendo.ui.progress($('body'), false);
            }
        });
    }
</script>