@using System.Collections
@using KadOzenka.Web.Helpers
@model KadOzenka.Web.Models.Task.ExportAttributesModel

@using (Html.BeginForm("TransferAttributes", "Task", FormMethod.Post))
{
    <div class="form-horizontal col-sm-12" style="margin-top: 10px">

        <div class="form-group">
            <div class="col-sm-2">
                @Html.CustomLabel("Тур оценки")
            </div>
            <div class="col-sm-4">
                @(Html.Kendo().DropDownList()
                              .Name("RatingTour")
                              .DataTextField("Text")
                              .DataValueField("Value")
                )
            </div>
        </div>

        <div class="form-group">
            <div class="col-sm-2">
                @Html.CustomLabelFor(x => x.TaskFilter)
            </div>
            <div class="col-sm-10">
                <select id="TaskFilter"></select>
            </div>
        </div>

        <div class="form-group">
            <div class="col-sm-9 col-sm-offset-2">
                <div class="radio-inline">
                    <label for="Parcel" style="font-weight: normal">Земельный участок</label>
                    <input type="radio" id="Parcel" name="ObjType" value="1" class="custom-control-input" checked>
                </div>
                <div class="radio-inline">
                    <label for="OKS" style="font-weight: normal">Объект капитального строительства</label>
                    <input type="radio" id="OKS" name="ObjType" value="0" class="custom-control-input">
                </div>
            </div>
        </div>

        <div id="attributesList">
            <div class="form-group attributes-list">
                <div class="col-sm-5 col-sm-offset-2">
                    <div>
                        @Html.KendoDropDownListWithAutocompleteFor(m => m.IdAttributeKO1, (IEnumerable)ViewData["KoAttributes"])
                    </div>
                </div>
                <div class="col-sm-5">
                    <div>
                        @Html.KendoDropDownListTreeWithButton(m => m.IdAttributeGBU1, (IEnumerable<DropDownTreeItemModel>)ViewData["TreeAttributes"])
                    </div>
                </div>
            </div>
            <div class="form-group attributes-list">
                <div class="col-sm-5 col-sm-offset-2">
                    <div>
                        @Html.KendoDropDownListWithAutocompleteFor(m => m.IdAttributeKO2, (IEnumerable)ViewData["KoAttributes"])
                    </div>
                </div>
                <div class="col-sm-5">
                    <div>
                        @Html.KendoDropDownListTreeWithButton(m => m.IdAttributeGBU2, (IEnumerable<DropDownTreeItemModel>)ViewData["TreeAttributes"])
                    </div>
                </div>
            </div>
            <div class="form-group attributes-list">
                <div class="col-sm-5 col-sm-offset-2">
                    <div>
                        @Html.KendoDropDownListWithAutocompleteFor(m => m.IdAttributeKO3, (IEnumerable)ViewData["KoAttributes"])
                    </div>
                </div>
                <div class="col-sm-5">
                    <div>
                        @Html.KendoDropDownListTreeWithButton(m => m.IdAttributeGBU3, (IEnumerable<DropDownTreeItemModel>)ViewData["TreeAttributes"])
                    </div>
                </div>
            </div>
            <div class="form-group attributes-list">
                <div class="col-sm-5 col-sm-offset-2">
                    <div>
                        @Html.KendoDropDownListWithAutocompleteFor(m => m.IdAttributeKO4, (IEnumerable)ViewData["KoAttributes"])
                    </div>
                </div>
                <div class="col-sm-5">
                    <div>
                        @Html.KendoDropDownListTreeWithButton(m => m.IdAttributeGBU4, (IEnumerable<DropDownTreeItemModel>)ViewData["TreeAttributes"])
                    </div>
                </div>
            </div>
            <div class="form-group attributes-list">
                <div class="col-sm-5 col-sm-offset-2">
                    <div>
                        @Html.KendoDropDownListWithAutocompleteFor(m => m.IdAttributeKO5, (IEnumerable)ViewData["KoAttributes"])
                    </div>
                </div>
                <div class="col-sm-5">
                    <div>
                        @Html.KendoDropDownListTreeWithButton(m => m.IdAttributeGBU5, (IEnumerable<DropDownTreeItemModel>)ViewData["TreeAttributes"])
                    </div>
                </div>
            </div>
            <div class="form-group attributes-list">
                <div class="col-sm-5 col-sm-offset-2">
                    <div>
                        @Html.KendoDropDownListWithAutocompleteFor(m => m.IdAttributeKO6, (IEnumerable)ViewData["KoAttributes"])
                    </div>
                </div>
                <div class="col-sm-5">
                    <div>
                        @Html.KendoDropDownListTreeWithButton(m => m.IdAttributeGBU6, (IEnumerable<DropDownTreeItemModel>)ViewData["TreeAttributes"])
                    </div>
                </div>
            </div>
            <div class="form-group attributes-list">
                <div class="col-sm-5 col-sm-offset-2">
                    <div>
                        @Html.KendoDropDownListWithAutocompleteFor(m => m.IdAttributeKO7, (IEnumerable)ViewData["KoAttributes"])
                    </div>
                </div>
                <div class="col-sm-5">
                    <div>
                        @Html.KendoDropDownListTreeWithButton(m => m.IdAttributeGBU7, (IEnumerable<DropDownTreeItemModel>)ViewData["TreeAttributes"])
                    </div>
                </div>
            </div>
            <div class="form-group attributes-list">
                <div class="col-sm-5 col-sm-offset-2">
                    <div>
                        @Html.KendoDropDownListWithAutocompleteFor(m => m.IdAttributeKO8, (IEnumerable)ViewData["KoAttributes"])
                    </div>
                </div>
                <div class="col-sm-5">
                    <div>
                        @Html.KendoDropDownListTreeWithButton(m => m.IdAttributeGBU8, (IEnumerable<DropDownTreeItemModel>)ViewData["TreeAttributes"])
                    </div>
                </div>
            </div>
            <div class="form-group attributes-list">
                <div class="col-sm-5 col-sm-offset-2">
                    <div>
                        @Html.KendoDropDownListWithAutocompleteFor(m => m.IdAttributeKO9, (IEnumerable)ViewData["KoAttributes"])
                    </div>
                </div>
                <div class="col-sm-5">
                    <div>
                        @Html.KendoDropDownListTreeWithButton(m => m.IdAttributeGBU9, (IEnumerable<DropDownTreeItemModel>)ViewData["TreeAttributes"])
                    </div>
                </div>
            </div>
            <div class="form-group attributes-list">
                <div class="col-sm-5 col-sm-offset-2">
                    <div>
                        @Html.KendoDropDownListWithAutocompleteFor(m => m.IdAttributeKO10, (IEnumerable)ViewData["KoAttributes"])
                    </div>
                </div>
                <div class="col-sm-5">
                    <div>
                        @Html.KendoDropDownListTreeWithButton(m => m.IdAttributeGBU10, (IEnumerable<DropDownTreeItemModel>)ViewData["TreeAttributes"])
                    </div>
                </div>
            </div>
        </div>

	    <div class="form-group">
		    <div class="col-sm-2">
			    @(Html.Kendo().Button()
				    .Name("addRow")
				    .Content("Добавить строчку").HtmlAttributes(new {@type = "button"})
				    )
		    </div>
		    <div class="col-sm-2 col-sm-offset-8">
			    @(Html.Kendo().Button()
					.Name("execute")
					.Content("Выполнить").HtmlAttributes(new { @type = "button" })
				    )
		    </div>
	    </div>
    </div>
}

<script type="text/x-kendo-template" id="templateRow">
	<div class="wrapper-#: rowNumber #" style="display: none">
	</div>
	</script>

<style>
    .attributes-list {
        padding-right: 2%;
    }
     
</style>

<script>
	var rowNumber = 1;

	function addNewRow() {
		kendo.ui.progress($('body'), true);
		var data = [{ rowNumber }];

		var templateContent = $("#templateRow").html();
		var template = kendo.template(templateContent);

		var result = kendo.render(template, data);

		$("#attributesList").append(result);

		var classWrapper = ".wrapper-" + rowNumber;

		var idTour = $('#RatingTour').data('kendoDropDownList').value();
		var objectType = $('input[name="ObjType"]:checked').val();

		var url = "@Url.Action("GetRowExport", "Task")";
		$(classWrapper).load(url, { rowNumber: rowNumber, tourId: idTour, objectType: objectType }, function(response) {
			$(classWrapper).show(500);
			rowNumber++;
			kendo.ui.progress($('body'), false);
		});
	}

	$(document).ready(function () {
		$('#addRow').on('click', addNewRow);

		$('[name="RatingTour"]')
			.kendoDropDownList({
				dataTextField: 'Text',
				dataValueField: 'Value',
				dataSource:
				{
					transport: {
						read: {
							url: '@Url.Action("GetRatingTours", "Tour")',
							dataType: 'json'
						}
					}
				}
			});

		$('[name="RatingTour"]').data('kendoDropDownList').bind('dataBound', initTasksList);
		$('[name="RatingTour"]').data('kendoDropDownList').bind('dataBound', initKoAttributes);
		$('[name="RatingTour"]').data('kendoDropDownList').bind('change', initTasksList);
		$('[name="RatingTour"]').data('kendoDropDownList').bind('change', initKoAttributes);
		$('[name="ObjType"]').on('change', initKoAttributes);

		$('#execute').on('click', transferAttributes);
	});




	function initTasksList() {
		var tourId = $('#RatingTour').val();
		var dataSource = new kendo.data.DataSource({
			transport: {
				read: {
					url: '@Url.Action("GetTasksByTour", "Task")',
					data: { tourId: tourId },
					dataType: 'json'
				}
			}
		});
		var tasksMultiSelect = $("#TaskFilter").data("kendoMultiSelect");
		if (tasksMultiSelect) {
			tasksMultiSelect.setDataSource(dataSource);
		} else {
			$('#TaskFilter').kendoMultiSelect({
				dataTextField: 'Text',
				dataValueField: 'Value',
				optionLabel: "--Выберите задание--",
				dataSource: dataSource
			});
		}
	}


	function initKoAttributes() {
		var tourId = $('#RatingTour').val();
		var objectType = $('input[name="ObjType"]:checked').val();

		var koAttributesSource = new kendo.data.DataSource({
			transport: {
				read: {
					url: '@Url.Action("GetKoAttributes", "Task")',
					data: { tourId: tourId, objectType: objectType },
					dataType: 'json'
				}
			}
		});
		$('[name^="IdAttributeKO"]').each(function() {
			$(this).kendoDropDownList({
				dataTextField: 'Text',
				dataValueField: 'Value',
				optionLabel: " ",
				dataSource: koAttributesSource
			});
		});
	}

	function parseFormObject(formObject) {
		if (!formObject) {
			return formObject;
		}
		var exportAttribute = [];
		for (var i = 1; i < rowNumber; i++) {
			var nameKo = 'IdAttributeKO_' + i;
			var nameGbu = 'IdAttributeGbu_' + i;

			exportAttribute.push({
				IdAttributeGbu: formObject[nameGbu],
				IdAttributeKO: formObject[nameKo]
			});
			delete formObject[nameGbu];
			delete formObject[nameKo];
		}
		return Object.assign({}, formObject, {ExportAttribute: exportAttribute});
	}

	function transferAttributes() {
		var form = $('form');
		var formObject = Common.Functions.FormToObject(form);
		formObject['TaskFilter'] = $("#TaskFilter").data('kendoMultiSelect').value();
		formObject['ObjType'] = $('input[name="ObjType"]:checked').val();

		formObject = parseFormObject(formObject);
		console.log('formObject', formObject);

		kendo.ui.progress($('body'), true);
		$.ajax({
			type: 'POST',
			url: form.attr('action'),
			data: formObject,
			success: function() {
				Common.ShowMessage('Операция успешно добавлена в очередь фоновых процессов');
			},
			error: function(response) {
				Common.ShowError(response.responseText);
			},
			complete: function() {
				kendo.ui.progress($('body'), false);
			}
		});
	}
</script>